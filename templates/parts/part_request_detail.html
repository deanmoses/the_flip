{% extends "layouts/two_column.html" %}
{% load static core_extras %}
{% block title %}
  {% if part_request.machine %}{{ part_request.machine.short_display_name }} ·{% endif %}
  Parts Request #{{ part_request.pk }} · {{ block.super }}
{% endblock %}
{% block breadcrumbs %}
  {% if part_request.machine %}
    <a href="{% url 'maintainer-machine-list' %}">Machines</a>
    <a href="{% url 'maintainer-machine-detail' part_request.machine.slug %}">{{ part_request.machine.short_display_name }}</a>
    <a href="{% url 'maintainer-machine-detail' part_request.machine.slug %}?f=parts">Parts</a>
    <span>{% icon "box-open" %} #{{ part_request.pk }}</span>
  {% else %}
    <a href="{% url 'part-request-list' %}">Parts Requests</a>
    <span>{% icon "box-open" %} #{{ part_request.pk }}</span>
  {% endif %}
{% endblock %}
{% block mobile_actions %}
  <div class="mobile-meta">
    <div class="mobile-meta__row"
         data-update-url="{% url 'part-request-status-update' part_request.pk %}">
      {% settable_part_request_status_pill part_request %}
      {% if part_request.machine %}
        <span class="text-muted text-sm">{{ part_request.machine.short_display_name }}</span>
      {% endif %}
    </div>
    <div class="mobile-meta__row text-muted text-sm">
      Requested by {{ part_request.requester_display }} on {{ part_request.occurred_at|smart_date }}
    </div>
  </div>
  <a href="{% url 'part-request-edit' part_request.pk %}"
     class="btn btn--secondary btn--full">{% icon "pen" class="meta" label="Edit Details" %}</a>
{% endblock %}
{% block sidebar %}
  {% include "components/history_link.html" with history_url=part_request.get_admin_history_url %}
  {% sidebar_section label="Parts Request" %}
  <div class="sidebar__title">{% icon "box-open" %} #{{ part_request.pk }}</div>
  <div class="flex flex-wrap stack-tight space-above-sm"
       data-update-url="{% url 'part-request-status-update' part_request.pk %}">
    {% settable_part_request_status_pill part_request %}
  </div>
  <div class="sidebar__subtitle space-above-sm">
    {{ part_request.requester_display }} · {{ part_request.occurred_at|smart_date }}
  </div>
{% endsidebar_section %}
{% if part_request.machine %}
  {% sidebar_section label="Machine" %}
  {% include "components/machine_sidebar_card.html" with machine=part_request.machine %}
{% endsidebar_section %}
{% endif %}
{% sidebar_section %}
<a href="{% url 'part-request-edit' part_request.pk %}"
   class="btn btn--secondary btn--full">
  {% icon "pen" class="meta" %}
  Edit Details
</a>
{% endsidebar_section %}
{% endblock %}
{% block main %}
  <!-- DESCRIPTION CARD -->
  {% include "core/partials/text_card_editable.html" with content=part_request.text %}
  <!-- MEDIA CARD -->
  {% include "core/partials/media_card_editable.html" with media_items=part_request.media.all alt="Part request photo" model_name="PartRequestMedia" %}
  <!-- UPDATES SECTION -->
  <div class="space-above-lg">
    <div class="section-header{% if not updates %} section-header--divider{% endif %}">
      <h3 class="section-header__title">Updates</h3>
      <a href="{% url 'part-request-update-create' part_request.pk %}"
         class="btn btn--log btn--sm">
        {% icon "plus" class="meta" %}
        Add Update
      </a>
    </div>
    {% child_list_search total_count=update_count search_value=search_query placeholder="Search updates..." %}
    <div id="log-container"
         class="space-above-sm"
         data-fetch-url="{% url 'part-request-updates' part_request.pk %}">
      {% if updates %}
        {% timeline id="log-list" %}
        {% for update in updates %}
          {% include "parts/partials/part_update_entry.html" with update=update %}
        {% endfor %}
      {% endtimeline %}
      <div id="log-pagination"
           data-next-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}0{% endif %}"></div>
    {% else %}
    {% empty_state empty_message="No updates yet." search_message="No updates match your search." is_search=search_query %}
    {% endif %}
    <div id="log-loading" class="hidden">Loading…</div>
    <div id="log-sentinel"></div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
  {% include "core/partials/markdown_textarea_scripts.html" %}
  <script src="{% static 'core/infinite_scroll.js' %}" defer></script>
  <script src="{% static 'core/settable_pill.js' %}" defer></script>
  <script>
    // Part request side effects: inject update entry + toast
    document.addEventListener('pill:updated', (event) => {
      const { field, value, label, data } = event.detail;
      if (field !== 'status') return;

      // Inject the new update into the updates list
      if (data.update_html) {
        const noUpdatesMsg = document.querySelector('#log-container > p.text-muted');
        if (noUpdatesMsg) noUpdatesMsg.remove();

        const template = document.createElement('template');
        template.innerHTML = data.update_html.trim();
        const newEntry = template.content.firstChild;

        let logList = document.getElementById('log-list');
        if (!logList) {
          logList = document.createElement('div');
          logList.className = 'timeline';
          logList.id = 'log-list';
          logList.innerHTML = '<div class="timeline__line"></div>';
          document.getElementById('log-container').prepend(logList);
        }

        const timelineLine = logList.firstElementChild;
        timelineLine.after(newEntry);
        applySmartDates(newEntry);
      }

      const pillHtml = `<span class="pill pill--neutral">${escapeHtml(label)}</span>`;
      showMessage('success', `Part request #{{ part_request.pk }} set to ${pillHtml}`);
    });
  </script>
  {% include "core/partials/markdown_inline_edit_scripts.html" %}
  <script src="{% static 'core/media_grid.js' %}" defer></script>
  <script src="{% static 'core/video_transcode_poll.js' %}" defer></script>
{% endblock %}
