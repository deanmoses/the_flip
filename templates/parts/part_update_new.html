{% extends "layouts/two_column.html" %}
{% load static core_extras %}
{% block title %}Add Update · Parts Request #{{ part_request.pk }} · {{ block.super }}{% endblock %}
{% block breadcrumbs %}
  <a href="{% url 'part-request-list' %}">Parts</a>
  <a href="{% url 'part-request-detail' part_request.pk %}">#{{ part_request.pk }}</a>
  <span>Add Update</span>
{% endblock %}
{% block sidebar %}
  {% sidebar_section label="Parts Request" %}
  <a href="{% url 'part-request-detail' part_request.pk %}"
     class="sidebar__title sidebar__link">
    <i class="fa-solid fa-box-open"></i> #{{ part_request.pk }}
  </a>
  <div class="flex flex-wrap stack-tight space-above-sm">
    <span class="pill pill--neutral">{{ part_request.get_status_display }}</span>
  </div>
{% endsidebar_section %}
{% if part_request.machine %}
  {% sidebar_section label="Machine" %}
  <a href="{% url 'maintainer-machine-detail' part_request.machine.slug %}"
     class="sidebar__title sidebar__link">{{ part_request.machine.display_name }}</a>
{% endsidebar_section %}
{% endif %}
{% if not is_shared_account %}
  {% sidebar_section label="Who" %}
  {% maintainer_autocomplete_field form.requester_name size="sm" show_label=False %}
{% endsidebar_section %}
{% endif %}
{% endblock %}
{% block main %}
  <div class="card card--padded">
    <div class="card__header">
      <div class="card__title">Add Update</div>
    </div>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {% if is_shared_account %}
        <!-- WHO (shared accounts only - in main content for mobile visibility) -->
        {% maintainer_autocomplete_field form.requester_name label="Who is posting this?" %}
      {% endif %}
      <!-- Comment -->
      <div class="form-field">
        {% form_label form.text %}
        {{ form.text }}
        {% field_errors form.text %}
        <!-- File upload (accumulates across multiple selections) -->
        <div class="form-hint space-above-sm" data-file-accumulator>
          <input type="file"
                 name="{{ form.media_file.html_name }}"
                 class="hidden"
                 multiple
                 accept="image/*,video/*,.heic,.heif"
                 data-file-input>
          <a href="#" class="file-upload-link" data-file-trigger>
            <i class="fa-solid fa-paperclip space-right-xs"></i>Add photos and videos
          </a>
          {% field_errors form.media_file %}
          <!-- Uploaded files preview -->
          <div class="file-preview-row" data-file-preview></div>
        </div>
      </div>
      <!-- Status change -->
      <div class="form-field">
        <label for="{{ form.new_status.id_for_label }}" class="form-label">Change status to</label>
        {{ form.new_status }}
        {% field_errors form.new_status %}
      </div>
      <!-- Submit -->
      <div class="form-actions">
        <a href="{% url 'part-request-detail' part_request.pk %}"
           class="btn btn--secondary">Cancel</a>
        <button type="submit" class="btn btn--log">Post Update</button>
      </div>
    </form>
  </div>
{% endblock %}
{% block extra_scripts %}
  <script src="{% static 'core/dropdown_keyboard.js' %}" defer></script>
  <script src="{% static 'core/maintainer_autocomplete.js' %}" defer></script>
  <script src="{% static 'core/file_accumulator.js' %}" defer></script>
{% endblock %}
