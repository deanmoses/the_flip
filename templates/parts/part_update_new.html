{% extends "layouts/two_column.html" %}
{% load static core_extras %}
{% block title %}Add Update · Parts Request #{{ part_request.pk }} · {{ block.super }}{% endblock %}
{% block breadcrumbs %}
  {% if part_request.machine %}
    <a href="{% url 'maintainer-machine-list' %}">Machines</a>
    <a href="{% url 'maintainer-machine-detail' part_request.machine.slug %}">{{ part_request.machine.short_display_name }}</a>
    <a href="{% url 'maintainer-machine-detail' part_request.machine.slug %}?f=parts">Parts</a>
    <a href="{% url 'part-request-detail' part_request.pk %}">#{{ part_request.pk }}</a>
    <span>Add Update</span>
  {% else %}
    <a href="{% url 'part-request-list' %}">Parts Requests</a>
    <a href="{% url 'part-request-detail' part_request.pk %}">#{{ part_request.pk }}</a>
    <span>Add Update</span>
  {% endif %}
{% endblock %}
{% block sidebar %}
  {% sidebar_section label="Parts Request" %}
  <a href="{% url 'part-request-detail' part_request.pk %}"
     class="sidebar__title sidebar__link">{% icon "box-open" %} #{{ part_request.pk }}</a>
  <div class="flex flex-wrap stack-tight space-above-sm">
    <span class="pill pill--neutral">{{ part_request.get_status_display }}</span>
  </div>
{% endsidebar_section %}
{% if part_request.machine %}
  {% sidebar_section label="Machine" %}
  {% include "components/machine_sidebar_card.html" with machine=part_request.machine %}
{% endsidebar_section %}
{% endif %}
{% if not is_shared_account %}
  {% sidebar_section label="Who" %}
  {% maintainer_autocomplete_field form.poster_name size="sm" show_label=False form_id="part-request-update-form" %}
{% endsidebar_section %}
{% endif %}
{% sidebar_section label="When" %}
<input type="datetime-local"
       id="{{ form.occurred_at.id_for_label }}"
       name="{{ form.occurred_at.html_name }}"
       class="form-input form-input--sm"
       form="part-request-update-form">
{% field_errors form.occurred_at %}
{% endsidebar_section %}
{% endblock %}
{% block main %}
  <form id="part-request-update-form"
        method="post"
        enctype="multipart/form-data"
        class="form-main">
    {% csrf_token %}
    <input type="hidden" name="browser_timezone" id="browser-timezone">
    {% if is_shared_account %}
      <!-- WHO (shared accounts only - in main content for mobile visibility) -->
      {% maintainer_autocomplete_field form.poster_name label="Who is posting this?" %}
    {% endif %}
    <!-- Comment -->
    <div class="form-field">
      {% form_label form.text %}
      {{ form.text }}
      {% field_errors form.text %}
      <!-- File upload (accumulates across multiple selections) -->
      <div class="form-hint space-above-sm" data-file-accumulator>
        <input type="file"
               name="{{ form.media_file.html_name }}"
               class="hidden"
               multiple
               accept="image/*,video/*,.heic,.heif"
               data-file-input>
        <a href="#" class="file-upload-link" data-file-trigger>
          {% icon "paperclip" class="space-right-xs" %}Add photos and videos
        </a>
        {% field_errors form.media_file %}
        <!-- Uploaded files preview -->
        <div class="file-preview-row" data-file-preview></div>
      </div>
    </div>
    <!-- Status change -->
    <div class="form-field">
      <label for="{{ form.new_status.id_for_label }}" class="form-label">Change status to</label>
      {{ form.new_status }}
      {% field_errors form.new_status %}
    </div>
    <!-- Submit -->
    <div class="form-actions">
      <a href="{% url 'part-request-detail' part_request.pk %}"
         class="btn btn--secondary">Cancel</a>
      <button type="submit" class="btn btn--log">Post Update</button>
    </div>
  </form>
{% endblock %}
{% block extra_scripts %}
  <script src="{% static 'core/dropdown_keyboard.js' %}" defer></script>
  <script src="{% static 'core/link_autocomplete.js' %}" defer></script>
  <script src="{% static 'core/task_list_enter.js' %}" defer></script>
  <script src="{% static 'core/maintainer_autocomplete.js' %}" defer></script>
  <script src="{% static 'core/file_accumulator.js' %}" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set browser timezone for form submission (handles DST correctly)
      document.getElementById('browser-timezone').value = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Set default occurred_at to current time in browser's local timezone
      const occurredAtInput = document.getElementById('{{ form.occurred_at.id_for_label }}');
      if (occurredAtInput && !occurredAtInput.value) {
        occurredAtInput.value = toDateTimeLocalValue(new Date());
      }

      // Auto-append status change text when user selects a new status
      const statusSelect = document.getElementById('{{ form.new_status.id_for_label }}');
      const textArea = document.getElementById('{{ form.text.id_for_label }}');
      const currentStatusLabel = '{{ part_request.get_status_display|escapejs }}';

      statusSelect.addEventListener('change', function() {
        if (this.value) {
          const newLabel = this.options[this.selectedIndex].text;
          const statusText = 'Status changed: ' + currentStatusLabel + ' \u2192 ' + newLabel;
          if (textArea.value) {
            textArea.value = statusText + '\n' + textArea.value;
          } else {
            textArea.value = statusText;
          }
        }
      });
    });
  </script>
{% endblock %}
