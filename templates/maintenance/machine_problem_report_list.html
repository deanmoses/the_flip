{% extends "base.html" %}
{% load core_extras %}
{% block title %}{{ machine.display_name }} Problem Reports · {{ block.super }}{% endblock %}
{% block content %}
  <nav class="page-header">
    <div class="page-header__left breadcrumb">
      <a href="{% url 'maintainer-machine-list' %}">Machines</a>
      <span>›</span>
      <a href="{% url 'maintainer-machine-detail' machine.slug %}">{{ machine.display_name }}</a>
      <span>›</span>
      <strong>Problem Reports</strong>
    </div>
  </nav>
  <div class="list-header">
    <div class="list-header__left">
      <form method="get" action="">
        <div class="form-field">{{ search_form.q }}</div>
      </form>
    </div>
    <div class="list-header__right">
      <a class="btn btn-primary"
         href="{% url 'problem-report-create-machine' machine.slug %}">Submit Problem Report</a>
    </div>
  </div>
  {% if reports %}
    <ul class="list machine-list">
      {% for report in reports %}
        <li class="machine-card js-clickable-card"
            data-url="{% url 'problem-report-detail' report.pk %}"
            tabindex="0"
            role="button"
            aria-label="View problem report">
          <div class="machine-card__row">
            <div class="machine-card__row-left">
              {% if report.problem_type != report.PROBLEM_OTHER %}
                <span class="machine-card__problem-label">{{ report.get_problem_type_display }}:</span>
              {% endif %}
              {{ report.description|default:"No description provided." }}
            </div>
            <div class="machine-card__meta-group">
              <span class="machine-card__timestamp">{{ report.created_at|smart_date }}</span>
              <span class="badge badge-status badge-{{ report.status }}">{{ report.get_status_display }}</span>
            </div>
          </div>
          {% if report.prefetched_log_entries %}
            {% with latest_log=report.prefetched_log_entries.0 %}
              <div class="machine-card__row">
                <div class="machine-card__row-left"></div>
                <div class="machine-card__location machine-card__problem-report-snippet">
                  <strong>Latest log:</strong> {{ latest_log.text }}
                </div>
              </div>
            {% endwith %}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
    {% if page_obj.has_other_pages %}
      <div class="pagination">
        {% if page_obj.has_previous %}
          <a href="?page=1{% if search_form.initial.q %}&q={{ search_form.initial.q }}{% endif %}"
             class="btn">First</a>
          <a href="?page={{ page_obj.previous_page_number }}{% if search_form.initial.q %}&q={{ search_form.initial.q }}{% endif %}"
             class="btn">Previous</a>
        {% endif %}
        <span class="pagination-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if search_form.initial.q %}&q={{ search_form.initial.q }}{% endif %}"
             class="btn">Next</a>
          <a href="?page={{ page_obj.paginator.num_pages }}{% if search_form.initial.q %}&q={{ search_form.initial.q }}{% endif %}"
             class="btn">Last</a>
        {% endif %}
      </div>
    {% endif %}
  {% else %}
    <p>
      {% if search_form.initial.q %}
        No problem reports match your search.
      {% else %}
        No problem reports found for this machine.
      {% endif %}
    </p>
  {% endif %}
{% endblock %}
