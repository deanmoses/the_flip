{% extends "layouts/two_column.html" %}
{% load static core_extras %}
{% block title %}
  {% if report.machine %}{{ report.machine.short_display_name }} ·{% endif %}
  Problem Report #{{ report.pk }} · {{ block.super }}
{% endblock %}
{% block breadcrumbs %}
  <a href="{% url 'maintainer-machine-list' %}">Machines</a>
  <a href="{% url 'maintainer-machine-detail' machine.slug %}">{{ machine.short_display_name }}</a>
  <a href="{% url 'maintainer-machine-detail' machine.slug %}?f=problems">Problems</a>
  <span>{% icon "bug" label="Problem" %} #{{ report.pk }}</span>
{% endblock %}
{% block mobile_actions %}
  <div class="mobile-meta"
       data-update-url="{% url 'problem-report-detail' report.pk %}"
       data-report-pk="{{ report.pk }}"
       data-machine-name="{{ machine.short_display_name }}">
    {# Settable status and priority pills #}
    <div class="mobile-meta__row">
      {% settable_problem_status_pill report %}
      {% settable_problem_priority_pill report %}
      {% problem_report_type_pill report %}
      <span class="text-muted text-sm">{{ machine.short_display_name }}</span>
    </div>
    {# Reporter and timestamp #}
    <div class="mobile-meta__row text-muted text-sm">{{ report|problem_report_meta }}</div>
  </div>
  <a href="{% url 'problem-report-edit' report.pk %}"
     class="btn btn--secondary btn--full">{% icon "pen" class="meta" label="Edit Details" %}</a>
{% endblock %}
{% block sidebar %}
  {% include "components/history_link.html" with history_url=report.get_admin_history_url %}
  {% sidebar_section label="Problem Report #"|addstr:report.pk %}
  <div class="flex flex-wrap stack-tight space-above-sm"
       data-update-url="{% url 'problem-report-detail' report.pk %}"
       data-report-pk="{{ report.pk }}"
       data-machine-name="{{ machine.short_display_name }}">
    {% settable_problem_status_pill report %}
    {% settable_problem_priority_pill report %}
    {% problem_report_type_pill report %}
  </div>
  <div class="sidebar__subtitle space-above-sm">{{ report|problem_report_meta }}</div>
{% endsidebar_section %}
{% sidebar_section label="Machine" %}
{% include "components/machine_sidebar_card.html" with editable=True %}
{% endsidebar_section %}
{% sidebar_section %}
<div class="flex stack-tight stack-column">
  <a href="{% url 'problem-report-edit' report.pk %}"
     class="btn btn--secondary btn--full">
    {% icon "pen" class="meta" %}
    Edit Details
  </a>
  <form method="post">
    {% csrf_token %}
    <button type="submit"
            class="btn btn--log btn--full{% if report.status != report.Status.OPEN %} hidden{% endif %}"
            data-status-action="close">
      {% icon "check" class="meta" %}
      Close Problem Report
    </button>
    <button type="submit"
            class="btn btn--report btn--full{% if report.status == report.Status.OPEN %} hidden{% endif %}"
            data-status-action="reopen">
      {% icon "rotate-left" class="meta" %}
      Re-Open Problem Report
    </button>
  </form>
</div>
{% endsidebar_section %}
{% endblock %}
{% block main %}
  <!-- DESCRIPTION CARD -->
  {% include "core/partials/text_card_editable.html" with content=report.description %}
  <!-- MEDIA CARD -->
  {% include "core/partials/media_card_editable.html" with media_items=report.media.all alt="Problem report photo" model_name="ProblemReportMedia" %}
  <!-- LOG ENTRIES SECTION -->
  <div class="space-above-lg">
    <div class="section-header{% if not log_entries %} section-header--divider{% endif %}">
      <h3 class="section-header__title">Log Entries</h3>
      <a href="{% url 'log-create-problem-report' report.pk %}"
         class="btn btn--log btn--sm">
        {% icon "plus" class="meta" %}
        Add Log
      </a>
    </div>
    {% child_list_search total_count=log_count search_value=search_query placeholder="Search logs..." %}
    <div id="log-container"
         class="space-above-sm"
         data-fetch-url="{% url 'problem-report-log-entries' report.pk %}">
      {% if log_entries %}
        {% timeline id="log-list" %}
        {% for entry in log_entries %}
          {% include "maintenance/partials/problem_report_log_entry.html" with entry=entry %}
        {% endfor %}
      {% endtimeline %}
      <div id="log-pagination"
           data-next-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}0{% endif %}"></div>
    {% else %}
    {% empty_state empty_message="No log entries yet." search_message="No log entries match your search." is_search=search_query %}
    {% endif %}
    <div id="log-loading" class="hidden">Loading…</div>
    <div id="log-sentinel"></div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
  {% include "core/partials/markdown_textarea_scripts.html" %}
  <script src="{% static 'core/infinite_scroll.js' %}" defer></script>
  <script src="{% static 'core/settable_pill.js' %}" defer></script>
  {% include "core/partials/markdown_inline_edit_scripts.html" %}
  <script src="{% static 'core/media_grid.js' %}" defer></script>
  <script src="{% static 'core/video_transcode_poll.js' %}" defer></script>
  <script src="{% static 'core/searchable_dropdown.js' %}" defer></script>
  <script src="{% static 'core/sidebar_card_edit.js' %}" defer></script>
  <script>
    // Problem report side effects: Close/Re-Open button toggle, toasts
    document.addEventListener('pill:updated', (event) => {
      const { field, value, label, data } = event.detail;
      const wrapper = event.target.closest('[data-update-url]') || event.target;
      const updateUrl = wrapper.dataset.updateUrl;
      const reportPk = wrapper.dataset.reportPk;
      const machineName = escapeHtml(wrapper.dataset.machineName || '');

      if (field === 'status') {
        const isOpen = value === 'open';
        const closeBtn = document.querySelector('[data-status-action="close"]');
        const reopenBtn = document.querySelector('[data-status-action="reopen"]');
        if (closeBtn) closeBtn.classList.toggle('hidden', !isOpen);
        if (reopenBtn) reopenBtn.classList.toggle('hidden', isOpen);
        showMessage(
          'success',
          `<a href="${updateUrl}">Problem #${reportPk}</a> on ${machineName} ${isOpen ? 're-opened' : 'closed'}`
        );
      } else if (field === 'priority') {
        const { pillClass, iconClass } = readPillStyling('priority');
        const iconHtml = iconClass ? `<i class="fa-solid ${iconClass} meta"></i> ` : '';
        const pillHtml = `<span class="pill ${pillClass}">${iconHtml}${escapeHtml(label)}</span>`;
        showMessage(
          'success',
          `<a href="${updateUrl}">Problem #${reportPk}</a> on ${machineName} set to ${pillHtml}`
        );
      }
    });
  </script>
{% endblock %}
