{% extends "layouts/two_column.html" %}
{% load static core_extras %}
{% block title %}New Log Entry Â· {{ block.super }}{% endblock %}
{% block breadcrumbs %}
  {% if is_global %}
    <a href="{% url 'log-list' %}">Logs</a>
    <span>New Log Entry</span>
  {% else %}
    <a href="{% url 'maintainer-machine-list' %}">Machines</a>
    {% if machine %}
      <a href="{% url 'maintainer-machine-detail' machine.slug %}">{{ machine.short_display_name }}</a>
    {% endif %}
    {% if problem_report %}
      <a href="{% url 'problem-report-detail' problem_report.pk %}">Problem #{{ problem_report.pk }}</a>
    {% endif %}
    <span>Log Work</span>
  {% endif %}
{% endblock %}
{% block sidebar %}
  {% if machine %}
    {% sidebar_section label="Machine" %}
    {% include "components/machine_sidebar_card.html" with machine=machine %}
  {% endsidebar_section %}
{% endif %}
{% if problem_report %}
  {% sidebar_section label="Problem" %}
  {% include "components/problem_report_sidebar_card.html" with problem_report=problem_report %}
{% endsidebar_section %}
{% endif %}
{% if not is_shared_account %}
  {% sidebar_section label="Who" %}
  {% maintainer_chip_input_field show_label=False form_id="log-entry-form" initial_maintainers=initial_maintainers errors=maintainer_errors %}
{% endsidebar_section %}
{% endif %}
{% sidebar_section label="When" %}
<input type="datetime-local"
       id="{{ form.occurred_at.id_for_label }}"
       name="{{ form.occurred_at.html_name }}"
       class="form-input form-input--sm"
       form="log-entry-form">
{% field_errors form.occurred_at %}
{% endsidebar_section %}
{% endblock %}
{% block main %}
  <form id="log-entry-form"
        method="post"
        enctype="multipart/form-data"
        class="form-main">
    {% csrf_token %}
    {% form_non_field_errors form %}
    <input type="hidden" name="browser_timezone" id="browser-timezone">
    {% if is_shared_account %}
      {% maintainer_chip_input_field label="Who did the work?" errors=maintainer_errors %}
    {% endif %}
    {% if is_global %}
      <div class="form-field">
        <label class="form-label">Machine</label>
        <div class="autocomplete"
             data-machine-autocomplete
             data-autocomplete-url="{% url 'api-machine-autocomplete' %}">
          <input type="search"
                 id="machine-log-search"
                 placeholder="Search machines..."
                 class="form-input"
                 autocomplete="off"
                 data-machine-search
                 required
                 value="{% if selected_machine %}{{ selected_machine.name }}{% endif %}">
          <input type="hidden"
                 name="{{ form.machine_slug.html_name }}"
                 id="{{ form.machine_slug.id_for_label }}"
                 value="{{ form.machine_slug.value|default_if_none:'' }}"
                 data-machine-slug-input>
          <div class="autocomplete__dropdown hidden"></div>
        </div>
        {% field_errors form.machine_slug %}
      </div>
    {% endif %}
    <div class="form-field">
      {% form_label form.text %}
      {{ form.text }}
      {% field_errors form.text %}
      <div class="form-hint space-above-sm" data-file-accumulator>
        <input type="file"
               name="{{ form.media_file.html_name }}"
               class="hidden"
               multiple
               accept="image/*,video/*,.heic,.heif"
               data-file-input>
        <a href="#" class="file-upload-link" data-file-trigger>
          {% icon "paperclip" class="space-right-xs" %}Add photos and videos
        </a>
        {% field_errors form.media_file %}
        <div class="file-preview-row" data-file-preview></div>
      </div>
    </div>
    <div class="form-actions">
      {% if problem_report %}
        <label class="checkbox-label">
          <input type="checkbox"
                 id="close_problem"
                 name="close_problem"
                 class="checkbox">
          <span>Close the problem report</span>
        </label>
      {% endif %}
      <a href="{% if is_global %}{% url 'log-list' %}{% elif problem_report %}{% url 'problem-report-detail' problem_report.pk %}{% else %}{% url 'maintainer-machine-detail' machine.slug %}?f=logs{% endif %}"
         class="btn btn--secondary">Cancel</a>
      <button type="submit" class="btn btn--log">
        {% icon "check" class="meta" %}
        Log It
      </button>
    </div>
  </form>
{% endblock %}
{% block extra_scripts %}
  <script src="{% static 'core/dropdown_keyboard.js' %}" defer></script>
  <script src="{% static 'core/link_autocomplete.js' %}" defer></script>
  <script src="{% static 'core/task_list_enter.js' %}" defer></script>
  <script src="{% static 'core/machine_autocomplete.js' %}" defer></script>
  <script src="{% static 'core/maintainer_chip_input.js' %}" defer></script>
  <script src="{% static 'core/file_accumulator.js' %}" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Set browser timezone for form submission (handles DST correctly)
      document.getElementById('browser-timezone').value = Intl.DateTimeFormat().resolvedOptions().timeZone;

      // Set default occurred_at to current time in browser's local timezone
      const occurredAtInput = document.getElementById('{{ form.occurred_at.id_for_label }}');
      if (occurredAtInput && !occurredAtInput.value) {
        occurredAtInput.value = toDateTimeLocalValue(new Date());
      }

      // Auto-resize description textarea to fit content
      const descriptionInput = document.getElementById('{{ form.text.id_for_label }}');
      if (descriptionInput) {
        const resize = () => {
          descriptionInput.style.height = 'auto';
          descriptionInput.style.height = `${descriptionInput.scrollHeight}px`;
          descriptionInput.style.overflowY = 'hidden';
        };
        resize();
        descriptionInput.addEventListener('input', resize);
      }
    });
  </script>
{% endblock %}
