{% extends "base.html" %}
{% load static core_extras %}
{% block title %}Log Entry · {{ entry.machine.display_name }} · {{ block.super }}{% endblock %}
{% block content %}
  <section>
    <nav class="page-header">
      <div class="page-header__left breadcrumb">
        <a href="{% url 'maintainer-machine-list' %}">Machines</a>
        <span>›</span>
        <a href="{% url 'maintainer-machine-detail' entry.machine.slug %}">{{ entry.machine.display_name }}</a>
        <span>›</span>
        <a href="{% url 'log-machine' entry.machine.slug %}">Logs</a>
      </div>
    </nav>
    <div class="work-date-container">
      <label for="work-date">Date of work</label>
      <input type="datetime-local"
             id="work-date"
             class="work-date-edit"
             data-utc="{{ entry.work_date.isoformat }}"
             data-entry-id="{{ entry.pk }}">
      <div id="work-date-status" class="save-status"></div>
    </div>
    <p>
      {% if entry.maintainers.all %}
        by {{ entry.maintainers.all|join:", " }}
      {% elif entry.maintainer_names %}
        by {{ entry.maintainer_names }}
      {% endif %}
    </p>
    <div class="entry-content">
      <div class="entry-text-container">
        <div id="text-view-mode">
          <div id="entry-text-display" class="markdown-content">{{ entry.text|render_markdown }}</div>
          <button type="button" id="edit-button" class="btn btn-secondary">Edit</button>
        </div>
        <div id="text-edit-mode" class="hidden">
          <textarea id="entry-text"
                    class="entry-text-edit"
                    data-entry-id="{{ entry.pk }}">{{ entry.text }}</textarea>
          <div class="edit-actions">
            <button type="button" id="save-button" class="btn btn-primary">Save</button>
            <button type="button" id="cancel-button" class="btn btn-secondary">Cancel</button>
            <span id="save-status" class="save-status"></span>
          </div>
        </div>
      </div>
      <div class="entry-media">
        <h3>Media</h3>
        <div id="media-container" class="media-grid">
          {% for media in entry.media.all %}
            <div class="media-item" data-media-id="{{ media.id }}">
              {% if media.media_type == 'video' %}
                {% if media.transcode_status == 'ready' and media.transcoded_file %}
                  <video controls poster="{{ media.poster_file.url }}" class="media-video">
                    <source src="{{ media.transcoded_file.url }}" type="video/mp4">
                    Your browser doesn't support video playback.
                  </video>
                {% elif media.transcode_status == 'processing' or media.transcode_status == 'pending' %}
                  <div class="media-status">Processing video…</div>
                {% else %}
                  <div class="media-status error">Video processing failed.</div>
                {% endif %}
              {% else %}
                <a href="{{ media.file.url }}" target="_blank" class="media-link">
                  <img src="{{ media.file.url }}" alt="Log entry photo">
                </a>
              {% endif %}
              <button type="button"
                      class="btn-delete-media"
                      data-media-id="{{ media.id }}"
                      aria-label="Delete media">×</button>
            </div>
          {% endfor %}
        </div>
        <div class="media-upload">
          <input type="file"
                 id="media-upload"
                 accept="image/*,video/*,.heic,.heif,image/heic,image/heif"
                 style="display: none">
          <button type="button" id="upload-button" class="btn btn-secondary">Upload Photo</button>
        </div>
      </div>
    </div>
  </section>
{% endblock %}
{% block extra_scripts %}
  <script>
      const ENTRY_ID = {{ entry.pk }};
      const CSRF_TOKEN = '{{ csrf_token }}';

      // Helper: format Date as datetime-local value (YYYY-MM-DDTHH:MM)
      function toDateTimeLocalValue(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      // Auto-save work_date
      const workDateInput = document.getElementById('work-date');
      const workDateStatus = document.getElementById('work-date-status');

      // On page load: convert UTC to browser local time
      const utcDateStr = workDateInput.dataset.utc;
      if (utcDateStr) {
          const utcDate = new Date(utcDateStr);
          workDateInput.value = toDateTimeLocalValue(utcDate);
      }

      workDateInput.addEventListener('change', async () => {
          workDateStatus.textContent = 'Saving...';
          workDateStatus.className = 'save-status editing';

          try {
              // Get timezone offset in minutes (negative for ahead of UTC)
              const tzOffsetMinutes = new Date().getTimezoneOffset();

              const formData = new FormData();
              formData.append('action', 'update_work_date');
              formData.append('work_date', workDateInput.value);
              formData.append('tz_offset', tzOffsetMinutes);
              formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

              const response = await fetch(window.location.href, {
                  method: 'POST',
                  body: formData
              });

              const data = await response.json();
              if (response.ok && data.success) {
                  workDateStatus.textContent = 'Saved';
                  workDateStatus.className = 'save-status saved';
                  setTimeout(() => {
                      workDateStatus.textContent = '';
                      workDateStatus.className = 'save-status';
                  }, 2000);
              } else {
                  workDateStatus.textContent = data.error || 'Error saving';
                  workDateStatus.className = 'save-status error';
              }
          } catch (error) {
              console.error('Save error:', error);
              workDateStatus.textContent = 'Error saving';
              workDateStatus.className = 'save-status error';
          }
      });

      // Text edit mode switching
      const textarea = document.getElementById('entry-text');
      const saveStatus = document.getElementById('save-status');
      const textViewMode = document.getElementById('text-view-mode');
      const textEditMode = document.getElementById('text-edit-mode');
      const editButton = document.getElementById('edit-button');
      const saveButton = document.getElementById('save-button');
      const cancelButton = document.getElementById('cancel-button');
      const textDisplay = document.getElementById('entry-text-display');

      let originalText = textarea.value;

      editButton.addEventListener('click', () => {
          originalText = textarea.value;
          textViewMode.classList.add('hidden');
          textEditMode.classList.remove('hidden');
          textarea.focus();
      });

      cancelButton.addEventListener('click', () => {
          textarea.value = originalText;
          saveStatus.textContent = '';
          saveStatus.className = 'save-status';
          textEditMode.classList.add('hidden');
          textViewMode.classList.remove('hidden');
      });

      saveButton.addEventListener('click', async () => {
          saveStatus.textContent = 'Saving...';
          saveStatus.className = 'save-status editing';

          try {
              const formData = new FormData();
              formData.append('action', 'update_text');
              formData.append('text', textarea.value);
              formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

              const response = await fetch(window.location.href, {
                  method: 'POST',
                  body: formData
              });

              if (response.ok) {
                  // Reload page to get server-rendered markdown
                  window.location.reload();
              } else {
                  saveStatus.textContent = 'Error saving';
                  saveStatus.className = 'save-status error';
              }
          } catch (error) {
              console.error('Save error:', error);
              saveStatus.textContent = 'Error saving';
              saveStatus.className = 'save-status error';
          }
      });

      // Upload media
      const uploadButton = document.getElementById('upload-button');
      const mediaInput = document.getElementById('media-upload');

      uploadButton.addEventListener('click', () => {
          mediaInput.click();
      });

      mediaInput.addEventListener('change', async (e) => {
          if (!e.target.files || !e.target.files[0]) return;

          const formData = new FormData();
          formData.append('action', 'upload_media');
          formData.append('file', e.target.files[0]);
          formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

          try {
              const response = await fetch(window.location.href, {
                  method: 'POST',
                  body: formData
              });

              const data = await response.json();
              if (data.success) {
                  // Add new media to the grid
                  const mediaContainer = document.getElementById('media-container');
                  const mediaItem = document.createElement('div');
                  mediaItem.className = 'media-item';
                  mediaItem.dataset.mediaId = data.media_id;
                  let content = '';
                  if (data.media_type === 'video') {
                      if (data.transcode_status === 'ready' && data.media_url) {
                          const posterAttr = data.poster_url ? ` poster="${data.poster_url}"` : '';
                          content = `
                <video controls${posterAttr} class="media-video">
                  <source src="${data.media_url}" type="video/mp4">
                  Your browser doesn't support video playback.
                </video>
              `;
                      } else if (data.transcode_status === 'failed') {
                          content = `<div class="media-status error">Video processing failed.</div>`;
                      } else {
                          content = `<div class="media-status">Processing video…</div>`;
                      }
                  } else {
                      content = `
              <a href="${data.media_url}" target="_blank" class="media-link">
                <img src="${data.media_url}" alt="Log entry photo">
              </a>
            `;
                  }
                  mediaItem.innerHTML = `
            ${content}
            <button type="button" class="btn-delete-media" data-media-id="${data.media_id}" aria-label="Delete media">×</button>
          `;
                  mediaContainer.appendChild(mediaItem);

                  // Attach delete handler to new button
                  attachDeleteHandler(mediaItem.querySelector('.btn-delete-media'));
              } else {
                  alert('Failed to upload media: ' + (data.error || 'Unknown error'));
              }
          } catch (error) {
              console.error('Upload error:', error);
              alert('Failed to upload media');
          }

          // Reset input
          e.target.value = '';
      });

      // Delete media
      function attachDeleteHandler(button) {
          button.addEventListener('click', async () => {
              const mediaId = button.dataset.mediaId;
              const formData = new FormData();
              formData.append('action', 'delete_media');
              formData.append('media_id', mediaId);
              formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

              try {
                  const response = await fetch(window.location.href, {
                      method: 'POST',
                      body: formData
                  });

                  if (response.ok) {
                      // Remove from DOM
                      const mediaItem = button.closest('.media-item');
                      mediaItem.remove();
                  } else {
                      alert('Failed to delete media');
                  }
              } catch (error) {
                  console.error('Delete error:', error);
                  alert('Failed to delete media');
              }
          });
      }

      // Attach delete handlers to existing media
      document.querySelectorAll('.btn-delete-media').forEach(attachDeleteHandler);
  </script>
  <style>
      .work-date-container {
          margin-bottom: 1.5rem;
      }

      .work-date-container label {
          display: block;
          font-weight: 600;
          margin-bottom: 0.5rem;
      }

      .work-date-edit {
          padding: 0.5rem;
          font-size: 1rem;
          border: 1px solid #ddd;
          border-radius: 4px;
      }

      .work-date-edit:focus {
          outline: none;
          border-color: #0066cc;
      }

      .entry-text-container {
          margin-bottom: 2rem;
      }

      .entry-text-edit {
          width: 100%;
          min-height: 200px;
          padding: 0.75rem;
          font-family: inherit;
          font-size: 1rem;
          border: 1px solid #ddd;
          border-radius: 4px;
          resize: vertical;
          white-space: pre-wrap;
      }

      .entry-text-edit:focus {
          outline: none;
          border-color: #0066cc;
      }

      .edit-actions {
          display: flex;
          align-items: center;
          gap: var(--space-2);
          margin-top: var(--space-2);
      }

      .save-status {
          font-size: 0.875rem;
      }

      .save-status.editing {
          color: var(--color-text-muted);
      }

      .save-status.error {
          color: var(--color-danger);
      }

      #edit-button {
          margin-top: var(--space-2);
      }

      .entry-media h3 {
          margin-bottom: 1rem;
      }

      .media-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 1rem;
          margin-bottom: 1rem;
      }

      .media-item {
          position: relative;
          border: 1px solid #ddd;
          border-radius: 4px;
          overflow: hidden;
      }

      .media-link {
          display: block;
          cursor: pointer;
          transition: opacity 0.2s ease;
      }

      .media-link:hover {
          opacity: 0.9;
      }

      .media-item img {
          width: 100%;
          height: auto;
          display: block;
      }

      .media-video {
          width: 100%;
          height: auto;
          max-height: 400px;
          display: block;
          object-fit: contain;
          background: #000;
      }

      .btn-delete-media {
          position: absolute;
          top: 0.5rem;
          right: 0.5rem;
          width: 2rem;
          height: 2rem;
          background: rgba(220, 53, 69, 0.9);
          color: white;
          border: none;
          border-radius: 50%;
          font-size: 1.5rem;
          line-height: 1;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .btn-delete-media:hover {
          background: rgba(220, 53, 69, 1);
      }

      .media-upload {
          margin-top: 1rem;
      }
  </style>
{% endblock %}
