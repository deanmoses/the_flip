{% extends "base.html" %}
{% load static core_extras %}
{% block title %}Edit Log Entry · {{ block.super }}{% endblock %}
{% block content %}
  <section>
    <nav class="page-header">
      <div class="page-header__left breadcrumb">
        <a href="{% url 'maintainer-machine-list' %}">Machines</a>
        <span>›</span>
        <a href="{% url 'maintainer-machine-detail' entry.machine.slug %}">{{ entry.machine.display_name }}</a>
        {% if entry.problem_report %}
          <span>›</span>
          <a href="{% url 'machine-problem-reports' entry.machine.slug %}">Problem Reports</a>
          <span>›</span>
          <a href="{% url 'problem-report-detail' entry.problem_report.pk %}">{{ entry.problem_report.created_at|smart_date }}</a>
        {% else %}
          <span>›</span>
          <a href="{% url 'log-machine' entry.machine.slug %}">Logs</a>
        {% endif %}
        <span>›</span>
        <strong>Edit Log Entry</strong>
      </div>
    </nav>
    <h3>Edit Log Entry</h3>
    {% if entry.problem_report %}
      <section class="flip-card">
        <div class="flip-card__top log-entry-meta">
          <div>Problem Report</div>
          {% if entry.problem_report.reporter_display %}
            <div class="flip-card__top-right">
              <strong>{{ entry.problem_report.created_at|smart_date }}</strong> by {{ entry.problem_report.reporter_display }}
            </div>
          {% endif %}
        </div>
        <div class="flip-card__main">
          {% if entry.problem_report.problem_type != entry.problem_report.PROBLEM_OTHER %}
            <p>{{ entry.problem_report.get_problem_type_display }}</p>
          {% endif %}
          {% if entry.problem_report.description %}<p>{{ entry.problem_report.description }}</p>{% endif %}
        </div>
      </section>
    {% endif %}
    <div class="work-date-container">
      <label for="work-date">Date of work</label>
      <input type="datetime-local"
             id="work-date"
             class="work-date-edit"
             data-utc="{{ entry.work_date.isoformat }}"
             data-entry-id="{{ entry.pk }}">
      <div id="work-date-status" class="status-indicator"></div>
    </div>
    <p>
      {% if entry.maintainers.all %}
        by {{ entry.maintainers.all|join:", " }}
      {% elif entry.maintainer_names %}
        by {{ entry.maintainer_names }}
      {% endif %}
    </p>
    <div class="entry-content">
      <div class="entry-text-container">
        <div id="text-view-mode">
          <div id="entry-text-display" class="markdown-content">{{ entry.text|render_markdown }}</div>
          <button type="button" id="edit-button" class="btn btn-secondary">Edit</button>
        </div>
        <div id="text-edit-mode" class="hidden">
          <textarea id="entry-text"
                    class="entry-text-edit"
                    data-entry-id="{{ entry.pk }}">{{ entry.text }}</textarea>
          <div class="edit-actions">
            <button type="button" id="save-button" class="btn btn-primary">Save</button>
            <button type="button" id="cancel-button" class="btn btn-secondary">Cancel</button>
            <span id="save-status" class="status-indicator"></span>
          </div>
        </div>
      </div>
      <div class="entry-media">
        <h3>Media</h3>
        <div id="media-container" class="media-grid">
          {% for media in entry.media.all %}
            <div class="media-item" data-media-id="{{ media.id }}">
              {% if media.media_type == 'video' %}
                {% if media.transcode_status == 'ready' and media.transcoded_file %}
                  <video controls poster="{{ media.poster_file.url }}" class="media-video">
                    <source src="{{ media.transcoded_file.url }}" type="video/mp4">
                    Your browser doesn't support video playback.
                  </video>
                {% elif media.transcode_status == 'processing' or media.transcode_status == 'pending' %}
                  <div class="media-status">Processing video…</div>
                {% else %}
                  <div class="media-status error">Video processing failed.</div>
                {% endif %}
              {% else %}
                <a href="{{ media.file.url }}" target="_blank" class="media-link">
                  <img src="{{ media.file.url }}" alt="Log entry photo">
                </a>
              {% endif %}
              <button type="button"
                      class="btn-delete-media"
                      data-media-id="{{ media.id }}"
                      aria-label="Delete media">×</button>
            </div>
          {% endfor %}
        </div>
        <div class="media-upload">
          <input type="file"
                 id="media-upload"
                 accept="image/*,video/*,.heic,.heif,image/heic,image/heif"
                 class="hidden">
          <button type="button" id="upload-button" class="btn btn-secondary">Upload Photo</button>
        </div>
      </div>
    </div>
  </section>
{% endblock %}
{% block extra_scripts %}
  <script>
      const ENTRY_ID = {{ entry.pk }};
      const CSRF_TOKEN = '{{ csrf_token }}';

      // Helper: format Date as datetime-local value (YYYY-MM-DDTHH:MM)
      function toDateTimeLocalValue(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      // Auto-save work_date
      const workDateInput = document.getElementById('work-date');
      const workDateStatus = document.getElementById('work-date-status');

      // On page load: convert UTC to browser local time
      const utcDateStr = workDateInput.dataset.utc;
      if (utcDateStr) {
          const utcDate = new Date(utcDateStr);
          workDateInput.value = toDateTimeLocalValue(utcDate);
      }

      workDateInput.addEventListener('change', async () => {
          workDateStatus.textContent = 'Saving...';
          workDateStatus.className = 'status-indicator saving';

          try {
              // Get timezone offset in minutes (negative for ahead of UTC)
              const tzOffsetMinutes = new Date().getTimezoneOffset();

              const formData = new FormData();
              formData.append('action', 'update_work_date');
              formData.append('work_date', workDateInput.value);
              formData.append('tz_offset', tzOffsetMinutes);
              formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

              const response = await fetch(window.location.href, {
                  method: 'POST',
                  body: formData
              });

              const data = await response.json();
              if (response.ok && data.success) {
                  workDateStatus.textContent = 'Saved';
                  workDateStatus.className = 'status-indicator saved';
                  setTimeout(() => {
                      workDateStatus.textContent = '';
                      workDateStatus.className = 'status-indicator';
                  }, 2000);
              } else {
                  workDateStatus.textContent = data.error || 'Error saving';
                  workDateStatus.className = 'status-indicator error';
              }
          } catch (error) {
              console.error('Save error:', error);
              workDateStatus.textContent = 'Error saving';
              workDateStatus.className = 'status-indicator error';
          }
      });

      // Text edit mode switching
      const textarea = document.getElementById('entry-text');
      const saveStatus = document.getElementById('save-status');
      const textViewMode = document.getElementById('text-view-mode');
      const textEditMode = document.getElementById('text-edit-mode');
      const editButton = document.getElementById('edit-button');
      const saveButton = document.getElementById('save-button');
      const cancelButton = document.getElementById('cancel-button');
      const textDisplay = document.getElementById('entry-text-display');

      let originalText = textarea.value;

      editButton.addEventListener('click', () => {
          originalText = textarea.value;
          textViewMode.classList.add('hidden');
          textEditMode.classList.remove('hidden');
          textarea.focus();
      });

      cancelButton.addEventListener('click', () => {
          textarea.value = originalText;
          saveStatus.textContent = '';
          saveStatus.className = 'status-indicator';
          textEditMode.classList.add('hidden');
          textViewMode.classList.remove('hidden');
      });

      saveButton.addEventListener('click', async () => {
          saveStatus.textContent = 'Saving...';
          saveStatus.className = 'status-indicator saving';

          try {
              const formData = new FormData();
              formData.append('action', 'update_text');
              formData.append('text', textarea.value);
              formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

              const response = await fetch(window.location.href, {
                  method: 'POST',
                  body: formData
              });

              if (response.ok) {
                  // Reload page to get server-rendered markdown
                  window.location.reload();
              } else {
                  saveStatus.textContent = 'Error saving';
                  saveStatus.className = 'status-indicator error';
              }
          } catch (error) {
              console.error('Save error:', error);
              saveStatus.textContent = 'Error saving';
              saveStatus.className = 'status-indicator error';
          }
      });

      // Upload media
      const uploadButton = document.getElementById('upload-button');
      const mediaInput = document.getElementById('media-upload');

      uploadButton.addEventListener('click', () => {
          mediaInput.click();
      });

      mediaInput.addEventListener('change', async (e) => {
          if (!e.target.files || !e.target.files[0]) return;

          const formData = new FormData();
          formData.append('action', 'upload_media');
          formData.append('file', e.target.files[0]);
          formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

          try {
              const response = await fetch(window.location.href, {
                  method: 'POST',
                  body: formData
              });

              const data = await response.json();
              if (data.success) {
                  // Add new media to the grid
                  const mediaContainer = document.getElementById('media-container');
                  const mediaItem = document.createElement('div');
                  mediaItem.className = 'media-item';
                  mediaItem.dataset.mediaId = data.media_id;
                  let content = '';
                  if (data.media_type === 'video') {
                      if (data.transcode_status === 'ready' && data.media_url) {
                          const posterAttr = data.poster_url ? ` poster="${data.poster_url}"` : '';
                          content = `
                <video controls${posterAttr} class="media-video">
                  <source src="${data.media_url}" type="video/mp4">
                  Your browser doesn't support video playback.
                </video>
              `;
                      } else if (data.transcode_status === 'failed') {
                          content = `<div class="media-status error">Video processing failed.</div>`;
                      } else {
                          content = `<div class="media-status">Processing video…</div>`;
                      }
                  } else {
                      content = `
              <a href="${data.media_url}" target="_blank" class="media-link">
                <img src="${data.media_url}" alt="Log entry photo">
              </a>
            `;
                  }
                  mediaItem.innerHTML = `
            ${content}
            <button type="button" class="btn-delete-media" data-media-id="${data.media_id}" aria-label="Delete media">×</button>
          `;
                  mediaContainer.appendChild(mediaItem);

                  // Attach delete handler to new button
                  attachDeleteHandler(mediaItem.querySelector('.btn-delete-media'));
              } else {
                  alert('Failed to upload media: ' + (data.error || 'Unknown error'));
              }
          } catch (error) {
              console.error('Upload error:', error);
              alert('Failed to upload media');
          }

          // Reset input
          e.target.value = '';
      });

      // Delete media
      function attachDeleteHandler(button) {
          button.addEventListener('click', async () => {
              const mediaId = button.dataset.mediaId;
              const formData = new FormData();
              formData.append('action', 'delete_media');
              formData.append('media_id', mediaId);
              formData.append('csrfmiddlewaretoken', CSRF_TOKEN);

              try {
                  const response = await fetch(window.location.href, {
                      method: 'POST',
                      body: formData
                  });

                  if (response.ok) {
                      // Remove from DOM
                      const mediaItem = button.closest('.media-item');
                      mediaItem.remove();
                  } else {
                      alert('Failed to delete media');
                  }
              } catch (error) {
                  console.error('Delete error:', error);
                  alert('Failed to delete media');
              }
          });
      }

      // Attach delete handlers to existing media
      document.querySelectorAll('.btn-delete-media').forEach(attachDeleteHandler);
  </script>
{% endblock %}
