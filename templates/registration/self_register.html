{% extends "layouts/two_column.html" %}
{% load core_extras %}
{% block title %}Register Â· {{ block.super }}{% endblock %}
{% block sidebar %}
  {% sidebar_section label="Register" %}
  <p class="text-muted text-sm">
    Create a new account or claim an existing one that was imported with the legacy maintenance records.
  </p>
{% endsidebar_section %}
{% endblock %}
{% block main %}
  <form method="post" id="registration-form" class="form-main">
    {% csrf_token %}
    {% form_non_field_errors form %}
    <!-- Username section -->
    <div class="form-field">
      {% form_label form.username %}
      <div class="input-with-button">
        <input type="text"
               name="username"
               id="id_username"
               class="form-input"
               value="{{ form.username.value|default:'' }}"
               required
               autocomplete="off"
               list="username-suggestions"
               placeholder="New or existing username"
               data-1p-ignore="true"
               data-lpignore="true">
        <button type="button" id="check-username-btn" class="btn btn--secondary">Check</button>
      </div>
      <datalist id="username-suggestions"></datalist>
      <small id="username-status"></small>
      {% field_errors form.username %}
    </div>
    <!-- Profile section (revealed after username check) -->
    <div id="profile-section" class="profile-section" hidden>
      <p id="registering-as" class="registering-as text-muted space-below-md"></p>
      <!-- Hidden username field for password managers -->
      <input type="hidden"
             name="username_hidden"
             autocomplete="username"
             id="id_username_hidden">
      <div class="form-field">
        {% form_label form.first_name %}
        <input type="text"
               name="first_name"
               id="id_first_name"
               class="form-input"
               value="{{ form.first_name.value|default:'' }}"
               autocomplete="given-name">
        {% field_errors form.first_name %}
      </div>
      <div class="form-field">
        {% form_label form.last_name %}
        <input type="text"
               name="last_name"
               id="id_last_name"
               class="form-input"
               value="{{ form.last_name.value|default:'' }}"
               autocomplete="family-name">
        {% field_errors form.last_name %}
      </div>
      <div class="form-field">
        {% form_label form.email %}
        <input type="email"
               name="email"
               id="id_email"
               class="form-input"
               value="{{ form.email.value|default:'' }}"
               autocomplete="email">
        {% field_errors form.email %}
      </div>
      <div class="form-field">
        {% form_label form.password %}
        <input type="password"
               name="password"
               id="id_password"
               class="form-input"
               required
               autocomplete="new-password">
        <label class="checkbox-label space-above-sm">
          <input type="checkbox" id="show-password" class="checkbox">
          <span>Show password</span>
        </label>
        {% field_errors form.password %}
      </div>
      <div class="form-actions">
        <a href="{% url 'home' %}" class="btn btn--secondary">Cancel</a>
        <button type="submit" class="btn btn--primary">Register</button>
      </div>
    </div>
  </form>
  <script>
    (function() {
      const usernameInput = document.getElementById('id_username');
      const usernameHidden = document.getElementById('id_username_hidden');
      const checkBtn = document.getElementById('check-username-btn');
      const statusEl = document.getElementById('username-status');
      const profileSection = document.getElementById('profile-section');
      const registeringAs = document.getElementById('registering-as');
      const datalist = document.getElementById('username-suggestions');
      const passwordInput = document.getElementById('id_password');
      const showPasswordCheckbox = document.getElementById('show-password');

      let debounceTimer;

      // Fetch suggestions as user types
      usernameInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 2) {
          datalist.innerHTML = '';
          return;
        }

        // Check if user selected from datalist (value matches an option exactly)
        const options = Array.from(datalist.options).map(o => o.value);
        if (options.includes(query)) {
          checkUsername();
          return;
        }

        debounceTimer = setTimeout(function() {
          fetch('/register/check-username/?q=' + encodeURIComponent(query))
            .then(r => r.json())
            .then(data => {
              datalist.innerHTML = data.suggestions
                .map(s => '<option value="' + s + '">')
                .join('');
            });
        }, 200);
      });

      // Check username availability
      function checkUsername() {
        const username = usernameInput.value.trim();
        if (!username) {
          statusEl.textContent = 'Please enter a username';
          statusEl.className = 'unavailable';
          return;
        }

        fetch('/register/check-username/?q=' + encodeURIComponent(username))
          .then(r => r.json())
          .then(data => {
            if (data.available) {
              statusEl.textContent = data.exists ? 'Available to claim' : 'Available';
              statusEl.className = 'available';
              profileSection.hidden = false;
              usernameHidden.value = username;
              registeringAs.innerHTML = (data.exists ? 'Claiming existing account: ' : 'Registering as: ') + '<code>' + username + '</code>';
              // Focus the first name field
              document.getElementById('id_first_name').focus();
            } else {
              statusEl.textContent = 'Not available';
              statusEl.className = 'unavailable';
              profileSection.hidden = true;
            }
          });
      }

      checkBtn.addEventListener('click', checkUsername);

      // Also check on Enter key in username field
      usernameInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          checkUsername();
        }
      });

      // Toggle password visibility
      showPasswordCheckbox.addEventListener('change', function() {
        passwordInput.type = this.checked ? 'text' : 'password';
      });

      // If form has errors, show profile section
      {% if form.errors %}
        profileSection.hidden = false;
        usernameHidden.value = usernameInput.value;
        registeringAs.innerHTML = 'Registering as: ' + '<code>' + usernameInput.value + '</code>';
      {% endif %}
    })();
  </script>
{% endblock %}
