{% extends "base.html" %}
{% load static core_extras %}
{% block title %}{{ machine.short_display_name }}{{ title_suffix }} Â· {{ block.super }}{% endblock %}
{% block content %}
  <!-- BREADCRUMBS -->
  <nav class="breadcrumbs breadcrumbs--responsive">
    <a href="{% url 'maintainer-machine-list' %}">Machines</a>
    {% if breadcrumb_label %}
      <a href="{% url 'maintainer-machine-detail' machine.slug %}">{{ machine.short_display_name }}</a>
      <span>{{ breadcrumb_label }}</span>
    {% else %}
      <span>{{ machine.short_display_name }}</span>
    {% endif %}
  </nav>
  <!-- TWO COLUMN LAYOUT: Main Content + Sidebar -->
  <div class="two-column">
    <!-- MOBILE ACTION BUTTONS (visible on mobile only) -->
    <div class="mobile-actions"
         data-update-url="{% url 'machine-inline-update' machine.slug %}">
      {% settable_machine_status_pill machine trigger_style="button" %}
      {% settable_machine_location_pill machine locations trigger_style="button" %}
      <a href="{% url 'machine-edit' machine.slug %}"
         class="btn btn--icon-only btn--secondary"
         aria-label="Edit machine"
         title="Edit machine">{% icon "pencil" %}</a>
      <a href="{% url 'problem-report-create-machine' machine.slug %}"
         class="btn btn--report"
         title="Report a problem">
        {% icon "bug" class="meta" %}
        Report
      </a>
      <a href="{% url 'log-create-machine' machine.slug %}"
         class="btn btn--log"
         title="Log maintenance work">
        {% icon "screwdriver-wrench" class="meta" %}
        Log
      </a>
    </div>
    <!-- SIDEBAR (desktop only) -->
    <aside class="two-column__sidebar">
      <div class="card card--padded sidebar--sticky">
        {% include "components/history_link.html" with history_url=machine.get_admin_history_url %}
        <!-- MACHINE INFO -->
        <div class="sidebar__section">
          <div class="sidebar__title">{{ machine.name }}</div>
          <div class="sidebar__subtitle">{{ machine.model|manufacturer_year }}</div>
          <div class="flex flex-wrap stack-tight space-above-sm"
               data-update-url="{% url 'machine-inline-update' machine.slug %}">
            {% settable_machine_status_pill machine %}
            {% settable_machine_location_pill machine locations %}
          </div>
        </div>
        <!-- ACTIONS -->
        <div class="sidebar__section">
          <div class="flex stack-tight stack-column">
            <a href="{% url 'machine-edit' machine.slug %}"
               class="btn btn--secondary btn--full">
              {% icon "pencil" class="meta" %}
              Edit Machine
            </a>
            <a href="{% url 'part-request-create-machine' machine.slug %}"
               class="btn btn--secondary btn--full">
              {% icon "box-open" class="meta" %}
              Request Parts
            </a>
            <a href="{% url 'problem-report-create-machine' machine.slug %}"
               class="btn btn--report btn--full">
              {% icon "bug" class="meta" %}
              Report Problem
            </a>
            <a href="{% url 'log-create-machine' machine.slug %}"
               class="btn btn--log btn--full">
              {% icon "screwdriver-wrench" class="meta" %}
              Log Work
            </a>
          </div>
        </div>
      </div>
    </aside>
    <!-- MAIN COLUMN -->
    <div class="two-column__main">
      <!-- FILTER BAR -->
      <div class="filter-bar">
        <!-- Filter Buttons (use query params instead of separate URLs) -->
        <div class="filter-bar__filters">
          <a href="{% url 'maintainer-machine-detail' machine.slug %}"
             class="pill pill--filter {% if active_filter == 'all' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            {% icon "list" %} All Activity
          </a>
          <a href="{% url 'maintainer-machine-detail' machine.slug %}?f=problems"
             class="pill pill--filter {% if active_filter == 'problems' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            {% icon "bug" %}
            Problems
          </a>
          <a href="{% url 'maintainer-machine-detail' machine.slug %}?f=logs"
             class="pill pill--filter {% if active_filter == 'logs' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            {% icon "screwdriver-wrench" %}
            Logs
          </a>
          <a href="{% url 'maintainer-machine-detail' machine.slug %}?f=parts"
             class="pill pill--filter {% if active_filter == 'parts' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            {% icon "box-open" %} Parts
          </a>
        </div>
        <!-- Search Box -->
        <div class="filter-bar__search">
          <form method="get" action="">
            {% if active_filter != 'all' %}<input type="hidden" name="f" value="{{ active_filter }}">{% endif %}
            <input type="search"
                   name="q"
                   placeholder="Search..."
                   value="{{ search_form.q.value|default:'' }}"
                   class="filter-bar__search-input">
            {% icon "magnifying-glass" class="filter-bar__search-icon" %}
          </form>
        </div>
      </div>
      <!-- FEED CONTENT (Timeline) -->
      <div id="log-container"
           data-fetch-url="{% url 'machine-feed-entries' machine.slug %}">
        {% if entries %}
          {% timeline id="log-list" entry_types=entry_types %}
          {% for entry in entries %}
            {% include "maintenance/partials/activity_entry.html" with entry=entry %}
          {% endfor %}
        {% endtimeline %}
      {% else %}
      {% empty_state empty_message=empty_message search_message=search_empty_message is_search=search_form.q.value %}
      {% endif %}
      <div id="log-pagination"
           data-next-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}0{% endif %}"></div>
    </div>
    <div id="log-loading" class="hidden">Loading...</div>
    <div id="log-sentinel"></div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
  <script src="{% static 'core/infinite_scroll.js' %}" defer></script>
  <script src="{% static 'core/settable_pill.js' %}" defer></script>
  <script src="{% static 'core/machine_pill_effects.js' %}" defer></script>
  <script src="{% static 'core/video_transcode_poll.js' %}" defer></script>
{% endblock extra_scripts %}
