{% extends "catalog/machine_feed_base.html" %}
{% load static core_extras %}
{% block infinite_scroll_url %}
  {% url 'machine-activity-entries' machine.slug %}
{% endblock %}
{% block sidebar_extras %}
  <div class="flex flex-wrap stack-tight space-above-sm">
    <div class="dropdown">
      <button type="button"
              class="pill {% if machine.operational_status == 'good' %}pill--status-good{% elif machine.operational_status == 'fixing' %}pill--status-fixing{% elif machine.operational_status == 'broken' %}pill--status-broken{% else %}pill--neutral{% endif %}"
              aria-haspopup="true"
              aria-expanded="false"
              onclick="toggleDropdown(this)">
        {% if machine.operational_status == 'fixing' %}
          <i class="fa-solid fa-wrench meta"></i>
        {% elif machine.operational_status == 'good' %}
          <i class="fa-solid fa-check meta"></i>
        {% elif machine.operational_status == 'broken' %}
          <i class="fa-solid fa-circle-xmark meta"></i>
        {% else %}
          <i class="fa-solid fa-circle-question meta"></i>
        {% endif %}
        {{ machine.get_operational_status_display }}
        <i class="fa-solid fa-caret-down meta"></i>
      </button>
      <div class="dropdown__menu dropdown__menu--left hidden">
        {% for value, label in machine.STATUS_CHOICES %}
          <button type="button"
                  class="dropdown__item"
                  data-field="operational_status"
                  data-value="{{ value }}"
                  onclick="updateMachineField(this)">{{ label }}</button>
        {% endfor %}
      </div>
    </div>
    <div class="dropdown">
      <button type="button"
              class="pill pill--neutral"
              aria-haspopup="true"
              aria-expanded="false"
              onclick="toggleDropdown(this)">
        <i class="fa-solid fa-location-dot meta"></i>
        {% if machine.location %}
          {{ machine.location.name }}
        {% else %}
          No Location
        {% endif %}
        <i class="fa-solid fa-caret-down meta"></i>
      </button>
      <div class="dropdown__menu dropdown__menu--left hidden">
        <button type="button"
                class="dropdown__item"
                data-field="location"
                data-value=""
                onclick="updateMachineField(this)">No Location</button>
        {% for loc in locations %}
          <button type="button"
                  class="dropdown__item"
                  data-field="location"
                  data-value="{{ loc.slug }}"
                  onclick="updateMachineField(this)">{{ loc.name }}</button>
        {% endfor %}
      </div>
    </div>
  </div>
  <span class="status-indicator body-small" id="save-indicator"></span>
{% endblock %}
{% block feed_content %}
  {% if activity_entries %}
    <div class="timeline">
      <div class="timeline__line"></div>
      <div id="log-list">
        {% for entry in activity_entries %}
          {% include "maintenance/partials/activity_entry.html" with entry=entry %}
        {% endfor %}
      </div>
    </div>
    <div id="log-pagination"
         data-next-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}0{% endif %}"></div>
  {% else %}
    <p class="text-muted">
      {% if search_form.q.value %}
        No activity matches your search.
      {% else %}
        No activity yet.
      {% endif %}
    </p>
  {% endif %}
{% endblock %}
{% block feed_scripts %}
  <script>
    // Inline editing for status and location via dropdown
    function updateMachineField(button) {
      const field = button.dataset.field;
      const value = button.dataset.value;
      const indicator = document.getElementById('save-indicator');

      indicator.textContent = 'Saving...';
      indicator.className = 'status-indicator body-small saving';

      // Close the dropdown
      button.closest('.dropdown__menu').classList.add('hidden');

      const formData = new FormData();
      formData.append('action', field === 'operational_status' ? 'update_status' : 'update_location');
      formData.append(field, value);

      fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCsrfToken()
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          indicator.textContent = 'Saved';
          indicator.className = 'status-indicator body-small saved';
          setTimeout(() => {
            window.location.reload();
          }, 500);
        } else {
          indicator.textContent = 'Error';
          indicator.className = 'status-indicator body-small error';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        indicator.textContent = 'Error';
        indicator.className = 'status-indicator body-small error';
      });
    }

    function getCsrfToken() {
      const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
      return cookieValue || '';
    }
  </script>
{% endblock %}
