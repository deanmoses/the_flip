{% extends "base.html" %}
{% load static core_extras %}
{% block title %}{{ object.display_name }} · {{ block.super }}{% endblock %}
{% block content %}
  <nav class="page-header">
    <div class="page-header__left breadcrumb">
      <a href="{% url 'maintainer-machine-list' %}">Machines</a>
      <span>›</span>
      <strong>{{ object.display_name }}</strong>
    </div>
    <div class="page-header__right">
      <a class="btn btn-secondary" href="{% url 'machine-edit' object.slug %}">Edit</a>
      <a class="btn btn-secondary" href="{% url 'machine-qr' object.slug %}">QR Code</a>
      <a class="btn btn-primary" href="{% url 'log-machine' object.slug %}">Logs</a>
      <a class="btn btn-primary"
         href="{% url 'machine-problem-reports' object.slug %}">
        Problem Reports
        {% if open_problem_reports.count > 0 %}
          <span class="badge badge-open badge-inline">{{ open_problem_reports.count }}</span>
        {% endif %}
      </a>
    </div>
  </nav>
  <fieldset class="form-section">
    <div class="inline-edit-group">
      <div class="form-field inline-edit-field">
        <label for="status-select">Status:</label>
        <select id="status-select"
                class="inline-edit-select"
                data-field="operational_status">
          {% for value, label in object.STATUS_CHOICES %}
            <option value="{{ value }}"
                    {% if object.operational_status == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        <span class="status-indicator" id="status-save-indicator"></span>
      </div>
      <div class="form-field inline-edit-field">
        <label for="location-select">Location:</label>
        <select id="location-select" class="inline-edit-select" data-field="location">
          <option value="" {% if not object.location %}selected{% endif %}>--</option>
          {% for loc in locations %}
            <option value="{{ loc.slug }}"
                    {% if object.location == loc %}selected{% endif %}>{{ loc.name }}</option>
          {% endfor %}
        </select>
        <span class="status-indicator" id="location-save-indicator"></span>
      </div>
    </div>
  </fieldset>
  <h2>Activity</h2>
  <div class="list-header">
    <div class="list-header__left">
      <form method="get" action="">
        <div class="form-field">{{ search_form.q }}</div>
      </form>
    </div>
    <div class="list-header__right">
      <a class="btn btn-primary"
         href="{% url 'log-create-machine' object.slug %}">Add Log Entry</a>
      <a class="btn btn-secondary"
         href="{% url 'problem-report-create' object.slug %}">Add Problem Report</a>
    </div>
  </div>
  <section>
    <div id="log-container"
         data-fetch-url="{% url 'machine-activity-entries' object.slug %}">
      {% if activity_entries %}
        <ul class="list machine-list" id="log-list">
          {% for entry in activity_entries %}
            {% include "maintenance/partials/activity_entry.html" with entry=entry %}
          {% endfor %}
        </ul>
        <div id="log-pagination"
             data-next-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}0{% endif %}"></div>
      {% else %}
        <p>
          {% if search_form.q.value %}
            No activity matches your search.
          {% else %}
            No activity yet.
          {% endif %}
        </p>
      {% endif %}
    </div>
    <div id="log-loading" class="hidden">Loading…</div>
    <div id="log-sentinel"></div>
  </section>
{% endblock %}
{% block extra_scripts %}
  <script src="{% static 'core/infinite_scroll.js' %}" defer></script>
  <script>
      // Inline editing for status and location
      document.addEventListener('DOMContentLoaded', function() {
          const statusSelect = document.getElementById('status-select');
          const locationSelect = document.getElementById('location-select');
          const statusIndicator = document.getElementById('status-save-indicator');
          const locationIndicator = document.getElementById('location-save-indicator');
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

          function getCsrfToken() {
              // Try to get CSRF token from cookie
              const cookieValue = document.cookie
                  .split('; ')
                  .find(row => row.startsWith('csrftoken='))
                  ?.split('=')[1];
              return cookieValue || csrfToken;
          }

          function updateField(field, value, indicator) {
              indicator.textContent = 'Saving...';
              indicator.className = 'status-indicator saving';

              const formData = new FormData();
              formData.append('action', field === 'operational_status' ? 'update_status' : 'update_location');
              formData.append(field, value);
              formData.append('csrfmiddlewaretoken', getCsrfToken());

              fetch(window.location.href, {
                      method: 'POST',
                      body: formData,
                      headers: {
                          'X-CSRFToken': getCsrfToken()
                      }
                  })
                  .then(response => response.json())
                  .then(data => {
                      if (data.status === 'success') {
                          indicator.textContent = 'Saved';
                          indicator.className = 'status-indicator saved';
                          setTimeout(() => {
                              indicator.textContent = '';
                              indicator.className = 'status-indicator';
                          }, 2000);
                      } else {
                          indicator.textContent = 'Error';
                          indicator.className = 'status-indicator error';
                      }
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      indicator.textContent = 'Error';
                      indicator.className = 'status-indicator error';
                  });
          }

          if (statusSelect) {
              statusSelect.addEventListener('change', function() {
                  updateField('operational_status', this.value, statusIndicator);
              });
          }

          if (locationSelect) {
              locationSelect.addEventListener('change', function() {
                  updateField('location', this.value, locationIndicator);
              });
          }
      });
  </script>
{% endblock extra_scripts %}
