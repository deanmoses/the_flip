{% extends "base.html" %}
{% load core_extras %}
{% block title %}{{ object.display_name }} · {{ block.super }}{% endblock %}
{% block content %}
  <div class="log-header">
    <h2>{{ object.display_name }}</h2>
    <div class="header-actions">
      <a class="btn btn-secondary" href="{% url 'machine-edit' object.slug %}">Edit</a>
      <a class="btn btn-primary" href="{% url 'log-machine' object.slug %}">View Logs</a>
      <a class="btn btn-primary" href="{% url 'machine-problem-reports' object.slug %}">All Problem Reports</a>
      <a class="btn btn-primary" href="{% url 'problem-report-create' object.slug %}">Submit Problem Report</a>
    </div>
  </div>
  <p>{{ object.model.manufacturer }} · {{ object.model.year }}</p>

  <div class="inline-edit-group">
    <div class="inline-edit-field">
      <label for="status-select">Status:</label>
      <select id="status-select" class="inline-edit-select" data-field="operational_status">
        {% for value, label in object.STATUS_CHOICES %}
          <option value="{{ value }}" {% if object.operational_status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <span class="inline-edit-status" id="status-save-indicator"></span>
    </div>

    <div class="inline-edit-field">
      <label for="location-select">Location:</label>
      <select id="location-select" class="inline-edit-select" data-field="location">
        <option value="" {% if not object.location %}selected{% endif %}>--</option>
        {% for value, label in object.LOCATION_CHOICES %}
          <option value="{{ value }}" {% if object.location == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <span class="inline-edit-status" id="location-save-indicator"></span>
    </div>
  </div>

  {% if open_problem_reports %}
    <section>
      <h3>Open Problem Reports</h3>
      <ul class="list machine-list">
        {% for report in open_problem_reports %}
          <li
            class="machine-card js-clickable-card"
            data-url="{% url 'problem-report-detail' report.pk %}"
            tabindex="0"
            role="button"
            aria-label="View problem report"
          >
            <div class="machine-card__row">
              <div class="machine-card__row-left">
                {% if report.problem_type != report.PROBLEM_OTHER %}
                  <span class="machine-card__problem-label">{{ report.get_problem_type_display }}:</span>
                {% endif %}
                {{ report.description|default:"No description provided." }}
              </div>
              <div class="machine-card__meta-group">
                <span class="machine-card__timestamp">{{ report.created_at|smart_date }}</span>
                <span class="badge badge-status badge-status--{{ report.status }}">
                  {{ report.get_status_display }}
                </span>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>
    </section>
  {% endif %}
{% endblock %}

{% block extra_js %}
<script>
  // Inline editing for status and location
  document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('status-select');
    const locationSelect = document.getElementById('location-select');
    const statusIndicator = document.getElementById('status-save-indicator');
    const locationIndicator = document.getElementById('location-save-indicator');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

    function getCsrfToken() {
      // Try to get CSRF token from cookie
      const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
      return cookieValue || csrfToken;
    }

    function updateField(field, value, indicator) {
      indicator.textContent = 'Saving...';
      indicator.className = 'inline-edit-status saving';

      const formData = new FormData();
      formData.append('action', field === 'operational_status' ? 'update_status' : 'update_location');
      formData.append(field, value);
      formData.append('csrfmiddlewaretoken', getCsrfToken());

      fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCsrfToken()
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          indicator.textContent = 'Saved';
          indicator.className = 'inline-edit-status saved';
          setTimeout(() => {
            indicator.textContent = '';
            indicator.className = 'inline-edit-status';
          }, 2000);
        } else {
          indicator.textContent = 'Error';
          indicator.className = 'inline-edit-status error';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        indicator.textContent = 'Error';
        indicator.className = 'inline-edit-status error';
      });
    }

    if (statusSelect) {
      statusSelect.addEventListener('change', function() {
        updateField('operational_status', this.value, statusIndicator);
      });
    }

    if (locationSelect) {
      locationSelect.addEventListener('change', function() {
        updateField('location', this.value, locationIndicator);
      });
    }
  });
</script>

<style>
  .inline-edit-group {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin: 1rem 0 2rem 0;
  }

  .inline-edit-field {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .inline-edit-field label {
    display: inline-block !important;
    font-weight: 600;
    margin: 0 !important;
    margin-bottom: 0 !important;
    white-space: nowrap;
  }

  .inline-edit-select {
    padding: 0.25rem 0.5rem;
    border: 1px solid var(--border-color, #ccc);
    border-radius: 4px;
    font-size: 0.95rem;
    min-width: 120px;
  }

  .inline-edit-status {
    font-size: 0.85rem;
    white-space: nowrap;
  }

  .inline-edit-status.saving {
    color: #666;
  }

  .inline-edit-status.saved {
    color: #28a745;
  }

  .inline-edit-status.error {
    color: #dc3545;
  }
</style>
{% endblock %}
