{% extends "base.html" %}
{% load static core_extras %}
{% block title %}
  {{ machine.name }}
  {% block feed_title %}{% endblock %}
  · {{ block.super }}
{% endblock %}
{% block content %}
  <!-- BREADCRUMBS -->
  <nav class="breadcrumbs breadcrumbs--responsive">
    <a href="{% url 'maintainer-machine-list' %}">Machines</a>
    <span>{{ machine.name }}</span>
  </nav>
  <!-- TWO COLUMN LAYOUT: Main Content + Sidebar -->
  <div class="two-column">
    <!-- MOBILE ACTION BUTTONS (visible on mobile only) -->
    <div class="mobile-actions"
         data-update-url="{% url 'machine-inline-update' machine.slug %}">
      <div class="dropdown">
        <button type="button"
                class="btn btn--dropdown status-btn {{ machine.operational_status|machine_status_btn_class }}"
                aria-haspopup="true"
                aria-expanded="false"
                aria-label="Change status"
                title="Status: {{ machine.get_operational_status_display }}"
                onclick="toggleDropdown(this)">
          {% icon machine.operational_status|machine_status_icon class="status-icon" %}
          {% icon "caret-down" class="btn__caret" %}
        </button>
        <div class="dropdown__menu dropdown__menu--left hidden">
          {% for value, label in machine.OperationalStatus.choices %}
            <button type="button"
                    class="dropdown__item{% if value == machine.operational_status %} dropdown__item--selected{% endif %}"
                    data-field="operational_status"
                    data-value="{{ value }}"
                    data-label="{{ label }}"
                    onclick="updateMachineField(this)">{{ label }}</button>
          {% endfor %}
        </div>
      </div>
      <div class="dropdown">
        <button type="button"
                class="btn btn--dropdown btn--secondary location-btn"
                aria-haspopup="true"
                aria-expanded="false"
                aria-label="Change location"
                title="Location: {% if machine.location %}{{ machine.location.name }}{% else %}None{% endif %}"
                onclick="toggleDropdown(this)">
          {% icon "location-dot" %}
          {% icon "caret-down" class="btn__caret" %}
        </button>
        <div class="dropdown__menu dropdown__menu--left hidden">
          {% if locations %}
            {% for loc in locations %}
              <button type="button"
                      class="dropdown__item{% if machine.location.slug == loc.slug %} dropdown__item--selected{% endif %}"
                      data-field="location"
                      data-value="{{ loc.slug }}"
                      data-label="{{ loc.name }}"
                      onclick="updateMachineField(this)">{{ loc.name }}</button>
            {% endfor %}
          {% endif %}
          <button type="button"
                  class="dropdown__item{% if not machine.location %} dropdown__item--selected{% endif %}"
                  data-field="location"
                  data-value=""
                  data-label="No Location"
                  onclick="updateMachineField(this)">No Location</button>
        </div>
      </div>
      <a href="{% url 'machine-edit' machine.slug %}"
         class="btn btn--icon-only btn--secondary"
         aria-label="Edit machine"
         title="Edit machine">{% icon "pencil" %}</a>
      <a href="{% url 'problem-report-create-machine' machine.slug %}"
         class="btn btn--report"
         title="Report a problem">
        {% icon "bug" class="meta" %}
        Report
      </a>
      <a href="{% url 'log-create-machine' machine.slug %}"
         class="btn btn--log"
         title="Log maintenance work">
        {% icon "screwdriver-wrench" class="meta" %}
        Log
      </a>
    </div>
    <!-- SIDEBAR (desktop only) -->
    <aside class="two-column__sidebar">
      <div class="card card--padded sidebar--sticky">
        {% include "components/history_link.html" with history_url=machine.get_admin_history_url %}
        <!-- MACHINE INFO -->
        <div class="sidebar__section">
          <div class="sidebar__title">{{ machine.name }}</div>
          <div class="sidebar__subtitle">
            {% if machine.model.manufacturer %}{{ machine.model.manufacturer }}{% endif %}
            {% if machine.model.manufacturer and machine.model.year %}·{% endif %}
            {% if machine.model.year %}{{ machine.model.year }}{% endif %}
          </div>
          <div class="flex flex-wrap stack-tight space-above-sm"
               data-update-url="{% url 'machine-inline-update' machine.slug %}">
            <div class="dropdown">
              <button type="button"
                      id="status-pill"
                      class="pill {{ machine.operational_status|machine_status_css_class }}"
                      aria-haspopup="true"
                      aria-expanded="false"
                      onclick="toggleDropdown(this)">
                {% icon machine.operational_status|machine_status_icon class="meta status-icon" %}
                <span class="status-label">{{ machine.get_operational_status_display }}</span>
                {% icon "caret-down" class="meta" %}
              </button>
              <div class="dropdown__menu dropdown__menu--left hidden">
                {% for value, label in machine.OperationalStatus.choices %}
                  <button type="button"
                          class="dropdown__item{% if value == machine.operational_status %} dropdown__item--selected{% endif %}"
                          data-field="operational_status"
                          data-value="{{ value }}"
                          data-label="{{ label }}"
                          onclick="updateMachineField(this)">{{ label }}</button>
                {% endfor %}
              </div>
            </div>
            <div class="dropdown">
              <button type="button"
                      id="location-pill"
                      class="pill pill--neutral"
                      aria-haspopup="true"
                      aria-expanded="false"
                      onclick="toggleDropdown(this)">
                {% icon "location-dot" class="meta" %}
                <span class="location-label">
                  {% if machine.location %}
                    {{ machine.location.name }}
                  {% else %}
                    No Location
                  {% endif %}
                </span>
                {% icon "caret-down" class="meta" %}
              </button>
              <div class="dropdown__menu dropdown__menu--left hidden">
                {% if locations %}
                  {% for loc in locations %}
                    <button type="button"
                            class="dropdown__item{% if machine.location.slug == loc.slug %} dropdown__item--selected{% endif %}"
                            data-field="location"
                            data-value="{{ loc.slug }}"
                            data-label="{{ loc.name }}"
                            onclick="updateMachineField(this)">{{ loc.name }}</button>
                  {% endfor %}
                {% endif %}
                <button type="button"
                        class="dropdown__item{% if not machine.location %} dropdown__item--selected{% endif %}"
                        data-field="location"
                        data-value=""
                        data-label="No Location"
                        onclick="updateMachineField(this)">No Location</button>
              </div>
            </div>
          </div>
          {% block sidebar_extras %}{% endblock %}
        </div>
        <!-- ACTIONS -->
        <div class="sidebar__section">
          <div class="flex stack-tight stack-column">
            <a href="{% url 'machine-edit' machine.slug %}"
               class="btn btn--secondary btn--full">
              {% icon "pencil" class="meta" %}
              Edit Machine
            </a>
            {% if config.PARTS_ENABLED %}
              <a href="{% url 'part-request-create-machine' machine.slug %}"
                 class="btn btn--secondary btn--full">
                {% icon "box-open" class="meta" %}
                Request Parts
              </a>
            {% endif %}
            <a href="{% url 'problem-report-create-machine' machine.slug %}"
               class="btn btn--report btn--full">
              {% icon "bug" class="meta" %}
              Report Problem
            </a>
            <a href="{% url 'log-create-machine' machine.slug %}"
               class="btn btn--log btn--full">
              {% icon "screwdriver-wrench" class="meta" %}
              Log Work
            </a>
          </div>
        </div>
      </div>
    </aside>
    <!-- MAIN COLUMN -->
    <div class="two-column__main">
      <!-- FILTER BAR -->
      <div class="filter-bar">
        <!-- Filter Buttons -->
        <div class="filter-bar__filters">
          <a href="{% url 'maintainer-machine-detail' machine.slug %}"
             class="pill pill--filter {% if active_filter == 'all' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            {% icon "list" %} All Activity
          </a>
          <a href="{% url 'log-machine' machine.slug %}"
             class="pill pill--filter {% if active_filter == 'logs' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            {% icon "screwdriver-wrench" %} Logs Only
          </a>
          <a href="{% url 'machine-problem-reports' machine.slug %}"
             class="pill pill--filter {% if active_filter == 'problems' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            {% icon "bug" %} Problems Only
          </a>
        </div>
        <!-- Search Box -->
        <div class="filter-bar__search">
          <form method="get" action="">
            <input type="search"
                   name="q"
                   placeholder="Search..."
                   value="{{ search_form.q.value|default:'' }}"
                   class="filter-bar__search-input">
            {% icon "magnifying-glass" class="filter-bar__search-icon" %}
          </form>
        </div>
      </div>
      <!-- FEED CONTENT (Timeline) -->
      <div id="log-container"
           data-fetch-url="{% block infinite_scroll_url %}{% endblock %}">
        {% block feed_content %}{% endblock %}
        <div id="log-pagination"
             data-next-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}0{% endif %}"></div>
      </div>
      <div id="log-loading" class="hidden">Loading…</div>
      <div id="log-sentinel"></div>
    </div>
  </div>
{% endblock %}
{% block extra_scripts %}
  <script src="{% static 'core/infinite_scroll.js' %}" defer></script>
  <script src="{% static 'core/video_transcode_poll.js' %}" defer></script>
  {% block feed_scripts %}{% endblock %}
{% endblock extra_scripts %}
