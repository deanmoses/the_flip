{% extends "base.html" %}
{% load static core_extras %}
{% block title %}
  {{ machine.display_name }}
  {% block feed_title %}{% endblock %}
  · {{ block.super }}
{% endblock %}
{% block content %}
  <!-- BREADCRUMBS -->
  <nav class="breadcrumbs breadcrumbs--responsive">
    <a href="{% url 'maintainer-machine-list' %}" class="breadcrumbs__link">Machines</a>
    <span>/</span>
    <span class="breadcrumbs__current">{{ machine.display_name }}</span>
  </nav>
  <!-- TWO COLUMN LAYOUT: Main Content + Sidebar -->
  <div class="two-column">
    <!-- MOBILE ACTION BUTTONS (visible on mobile only) -->
    <div class="mobile-actions">
      <a href="{% url 'machine-edit' machine.slug %}"
         class="btn btn--secondary">
        <i class="fa-solid fa-gear meta"></i>
        Edit
      </a>
      <a href="{% url 'problem-report-create-machine' machine.slug %}"
         class="btn btn--report">
        <i class="fa-solid fa-bug meta"></i>
        Report
      </a>
      <a href="{% url 'log-create-machine' machine.slug %}"
         class="btn btn--log">
        <i class="fa-solid fa-screwdriver-wrench meta"></i>
        Log
      </a>
    </div>
    <!-- SIDEBAR (desktop only) -->
    <aside class="two-column__sidebar">
      <div class="card card--padded sidebar--sticky">
        <!-- MACHINE INFO -->
        <div class="sidebar__section">
          <div class="sidebar__title">{{ machine.display_name }}</div>
          <div class="sidebar__subtitle">
            {% if machine.model.manufacturer %}{{ machine.model.manufacturer }}{% endif %}
            {% if machine.model.manufacturer and machine.model.year %}·{% endif %}
            {% if machine.model.year %}{{ machine.model.year }}{% endif %}
          </div>
          <div class="flex flex-wrap stack-tight space-above-sm"
               data-update-url="{% url 'machine-inline-update' machine.slug %}">
            <div class="dropdown">
              <button type="button"
                      id="status-pill"
                      class="pill {% if machine.operational_status == 'good' %}pill--status-good{% elif machine.operational_status == 'fixing' %}pill--status-fixing{% elif machine.operational_status == 'broken' %}pill--status-broken{% else %}pill--neutral{% endif %}"
                      aria-haspopup="true"
                      aria-expanded="false"
                      onclick="toggleDropdown(this)">
                <i class="fa-solid {% if machine.operational_status == 'fixing' %}fa-wrench{% elif machine.operational_status == 'good' %}fa-check{% elif machine.operational_status == 'broken' %}fa-circle-xmark{% else %}fa-circle-question{% endif %} meta status-icon"></i>
                <span class="status-label">{{ machine.get_operational_status_display }}</span>
                <i class="fa-solid fa-caret-down meta"></i>
              </button>
              <div class="dropdown__menu dropdown__menu--left hidden">
                {% for value, label in machine.STATUS_CHOICES %}
                  <button type="button"
                          class="dropdown__item"
                          data-field="operational_status"
                          data-value="{{ value }}"
                          data-label="{{ label }}"
                          onclick="updateMachineField(this)">{{ label }}</button>
                {% endfor %}
              </div>
            </div>
            <div class="dropdown">
              <button type="button"
                      id="location-pill"
                      class="pill pill--neutral"
                      aria-haspopup="true"
                      aria-expanded="false"
                      onclick="toggleDropdown(this)">
                <i class="fa-solid fa-location-dot meta"></i>
                <span class="location-label">
                  {% if machine.location %}
                    {{ machine.location.name }}
                  {% else %}
                    No Location
                  {% endif %}
                </span>
                <i class="fa-solid fa-caret-down meta"></i>
              </button>
              <div class="dropdown__menu dropdown__menu--left hidden">
                <button type="button"
                        class="dropdown__item"
                        data-field="location"
                        data-value=""
                        data-label="No Location"
                        onclick="updateMachineField(this)">No Location</button>
                {% if locations %}
                  {% for loc in locations %}
                    <button type="button"
                            class="dropdown__item"
                            data-field="location"
                            data-value="{{ loc.slug }}"
                            data-label="{{ loc.name }}"
                            onclick="updateMachineField(this)">{{ loc.name }}</button>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
          {% block sidebar_extras %}{% endblock %}
        </div>
        <!-- ACTIONS -->
        <div class="sidebar__section">
          <div class="flex stack-tight stack-column">
            <a href="{% url 'machine-edit' machine.slug %}"
               class="btn btn--secondary btn--full">
              <i class="fa-solid fa-gear meta"></i>
              Edit Machine
            </a>
            <a href="{% url 'machine-qr' machine.slug %}"
               class="btn btn--secondary btn--full">
              <i class="fa-solid fa-qrcode meta"></i>
              QR Code
            </a>
            <a href="{% url 'problem-report-create-machine' machine.slug %}"
               class="btn btn--report btn--full">
              <i class="fa-solid fa-bug meta"></i>
              Report Problem
            </a>
            <a href="{% url 'log-create-machine' machine.slug %}"
               class="btn btn--log btn--full">
              <i class="fa-solid fa-screwdriver-wrench meta"></i>
              Log Work
            </a>
          </div>
        </div>
      </div>
    </aside>
    <!-- MAIN COLUMN -->
    <div class="two-column__main">
      <!-- FILTER BAR -->
      <div class="filter-bar">
        <!-- Filter Buttons -->
        <div class="filter-bar__filters">
          <a href="{% url 'maintainer-machine-detail' machine.slug %}"
             class="pill pill--filter {% if active_filter == 'all' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            <i class="fa-solid fa-list"></i> All Activity
          </a>
          <a href="{% url 'log-machine' machine.slug %}"
             class="pill pill--filter {% if active_filter == 'logs' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            <i class="fa-solid fa-screwdriver-wrench"></i> Logs Only
          </a>
          <a href="{% url 'machine-problem-reports' machine.slug %}"
             class="pill pill--filter {% if active_filter == 'problems' %}pill--filter-active{% else %}pill--neutral{% endif %}">
            <i class="fa-solid fa-bug"></i> Problems Only
          </a>
        </div>
        <!-- Search Box -->
        <div class="filter-bar__search">
          <form method="get" action="">
            <input type="search"
                   name="q"
                   placeholder="Search..."
                   value="{{ search_form.q.value|default:'' }}"
                   class="filter-bar__search-input">
            <i class="fa-solid fa-magnifying-glass filter-bar__search-icon"></i>
          </form>
        </div>
      </div>
      <!-- FEED CONTENT (Timeline) -->
      <div id="log-container"
           data-fetch-url="{% block infinite_scroll_url %}{% endblock %}">
        {% block feed_content %}{% endblock %}
      </div>
      <div id="log-loading" class="hidden">Loading…</div>
      <div id="log-sentinel"></div>
    </div>
  </div>
{% endblock %}
{% block extra_scripts %}
  <script src="{% static 'core/infinite_scroll.js' %}" defer></script>
  {% block feed_scripts %}
    <script>
      function showFlashMessage(kind, text) {
        let container = document.querySelector('.messages');
        if (!container) {
          const main = document.querySelector('.main-content') || document.body;
          container = document.createElement('div');
          container.className = 'messages';
          main.prepend(container);
        }
        const msg = document.createElement('div');
        msg.className = `message message--${kind}`;
        msg.innerHTML = text;
        container.appendChild(msg);
      }

      function getCsrfToken() {
        const match = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
        return match ? match.split('=')[1] : '';
      }

      function updateMachineField(button) {
        const field = button.dataset.field;
        const value = button.dataset.value;
        const label = button.dataset.label;
        const dropdownMenu = button.closest('.dropdown__menu');
        const wrapper = dropdownMenu.parentElement.parentElement;
        const updateUrl = wrapper.dataset.updateUrl;
        if (!updateUrl) return;

        dropdownMenu.classList.add('hidden');

        const formData = new FormData();
        formData.append('action', field === 'operational_status' ? 'update_status' : 'update_location');
        formData.append(field, value);

        fetch(updateUrl, {
          method: 'POST',
          body: formData,
          credentials: 'same-origin',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCsrfToken(),
          }
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'noop') {
            return;
          } else if (data.status === 'success') {
            if (field === 'operational_status') {
              const pill = document.getElementById('status-pill');
              const labelEl = pill.querySelector('.status-label');
              const iconEl = pill.querySelector('.status-icon');
              labelEl.textContent = label;
              const statusClassMap = {
                good: 'pill--status-good',
                fixing: 'pill--status-fixing',
                broken: 'pill--status-broken',
                unknown: 'pill--neutral'
              };
              const iconClassMap = {
                good: 'fa-check',
                fixing: 'fa-wrench',
                broken: 'fa-circle-xmark',
                unknown: 'fa-circle-question'
              };
              // reset classes
              pill.className = 'pill ' + (statusClassMap[value] || 'pill--neutral');
              iconEl.className = 'fa-solid meta status-icon ' + (iconClassMap[value] || 'fa-circle-question');
              const machineName = document.querySelector('.sidebar__title')?.textContent?.trim() || 'Machine';
              const pillHtml = `<span class="pill ${statusClassMap[value] || 'pill--neutral'}"><i class="fa-solid ${iconClassMap[value] || 'fa-circle-question'} meta"></i> ${label}</span>`;
              showFlashMessage('success', `Status of ${machineName} set to ${pillHtml}`);
            } else {
              const pill = document.getElementById('location-pill');
              const labelEl = pill.querySelector('.location-label');
              labelEl.textContent = label;
              showFlashMessage('success', `Location set to ${label}`);
            }
          } else {
            showFlashMessage('error', 'Error saving change');
          }
        })
        .catch(() => showFlashMessage('error', 'Error saving change'));
      }
    </script>
  {% endblock %}
{% endblock extra_scripts %}
