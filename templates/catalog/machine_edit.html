{% extends "layouts/two_column.html" %}
{% load core_extras %}
{% block title %}Edit {{ object.display_name }} · {{ block.super }}{% endblock %}
{% block breadcrumbs %}
  <a href="{% url 'maintainer-machine-list' %}">Machines</a>
  <a href="{% url 'maintainer-machine-detail' object.slug %}">{{ object.short_display_name }}</a>
  <span>Edit</span>
{% endblock %}
{% block mobile_actions %}
  <a href="{% url 'machine-model-edit' object.model.slug %}"
     class="btn btn--secondary btn--full">
    <i class="fa-solid fa-pencil meta"></i>
    Edit Model
  </a>
{% endblock %}
{% block sidebar %}
  {% include "components/history_link.html" with history_url=object.get_admin_history_url %}
  {% sidebar_section %}
  <div class="sidebar__title">{{ object.display_name }}</div>
  <div class="sidebar__subtitle">
    {% if object.model.manufacturer %}{{ object.model.manufacturer }}{% endif %}
    {% if object.model.manufacturer and object.model.year %}·{% endif %}
    {% if object.model.year %}{{ object.model.year }}{% endif %}
  </div>
  <div class="flex flex-wrap stack-tight space-above-sm"
       data-update-url="{% url 'machine-inline-update' object.slug %}">
    <div class="dropdown">
      <button type="button"
              id="status-pill"
              class="pill {{ object.operational_status|machine_status_css_class }}"
              aria-haspopup="true"
              aria-expanded="false"
              onclick="toggleDropdown(this)">
        <i class="fa-solid {{ object.operational_status|machine_status_icon }} meta status-icon"></i>
        <span class="status-label">{{ object.get_operational_status_display }}</span>
        <i class="fa-solid fa-caret-down meta"></i>
      </button>
      <div class="dropdown__menu dropdown__menu--left hidden">
        {% for value, label in object.OperationalStatus.choices %}
          <button type="button"
                  class="dropdown__item"
                  data-field="operational_status"
                  data-value="{{ value }}"
                  data-label="{{ label }}"
                  onclick="updateMachineField(this)">{{ label }}</button>
        {% endfor %}
      </div>
    </div>
    <div class="dropdown">
      <button type="button"
              id="location-pill"
              class="pill pill--neutral"
              aria-haspopup="true"
              aria-expanded="false"
              onclick="toggleDropdown(this)">
        <i class="fa-solid fa-location-dot meta"></i>
        <span class="location-label">
          {% if object.location %}
            {{ object.location.name }}
          {% else %}
            No Location
          {% endif %}
        </span>
        <i class="fa-solid fa-caret-down meta"></i>
      </button>
      <div class="dropdown__menu dropdown__menu--left hidden">
        <button type="button"
                class="dropdown__item"
                data-field="location"
                data-value=""
                data-label="No Location"
                onclick="updateMachineField(this)">No Location</button>
        {% for loc in locations %}
          <button type="button"
                  class="dropdown__item"
                  data-field="location"
                  data-value="{{ loc.slug }}"
                  data-label="{{ loc.name }}"
                  onclick="updateMachineField(this)">{{ loc.name }}</button>
        {% endfor %}
      </div>
    </div>
  </div>
{% endsidebar_section %}
{% sidebar_section %}
<a href="{% url 'machine-qr' object.slug %}"
   class="btn btn--secondary btn--full">
  <i class="fa-solid fa-qrcode meta"></i>
  QR Code
</a>
{% endsidebar_section %}
{% sidebar_section label="Model" %}
<div class="sidebar__title">{{ object.model.name }}</div>
<a href="{% url 'machine-model-edit' object.model.slug %}"
   class="btn btn--secondary btn--full">
  <i class="fa-solid fa-pencil meta"></i>
  Edit Model
</a>
{% endsidebar_section %}
{% endblock %}
{% block main %}
  <div class="card card--padded">
    <form method="post" class="form-main">
      {% csrf_token %}
      {% form_non_field_errors form %}
      {% for fieldset_title, field_names in form.fieldsets %}
        <fieldset class="form-section">
          <legend>{{ fieldset_title }}</legend>
          {% for field_name in field_names %}
            {% with field=form|getfield:field_name %}
              {% form_field field %}
            {% endwith %}
          {% endfor %}
        </fieldset>
      {% endfor %}
      <div class="form-actions">
        <a href="{% url 'maintainer-machine-detail' object.slug %}"
           class="btn btn--secondary">
          <i class="fa-solid fa-circle-xmark meta"></i>
          Cancel
        </a>
        <button type="submit" class="btn btn--log">
          <i class="fa-solid fa-floppy-disk meta"></i>
          Save Changes
        </button>
      </div>
    </form>
  </div>
{% endblock %}
