{% extends "layouts/two_column.html" %}
{% load core_extras %}
{% block title %}Add Machine Â· {{ block.super }}{% endblock %}
{% block breadcrumbs %}
  <nav class="breadcrumbs breadcrumbs--responsive">
    <a href="{% url 'maintainer-machine-list' %}" class="breadcrumbs__link">Machines</a>
    <span>/</span>
    <span class="breadcrumbs__current">Add Machine</span>
  </nav>
{% endblock %}
{% block mobile_actions %}
  <a href="{% url 'maintainer-machine-list' %}" class="btn btn--secondary">
    <i class="fa-solid fa-arrow-left meta"></i>
    Back to Machines
  </a>
{% endblock %}
{% block sidebar %}
  {% sidebar %}
  {% sidebar_section label="Add Machine" %}
  <p class="sidebar__meta">Add a new machine to the collection</p>
{% endsidebar_section %}
{% sidebar_section %}
<a href="{% url 'maintainer-machine-list' %}"
   class="btn btn--secondary btn--full">
  <i class="fa-solid fa-arrow-left meta"></i>
  Back to Machines
</a>
{% endsidebar_section %}
{% endsidebar %}
{% endblock %}
{% block main %}
  <div class="card card--padded">
    <form method="post" class="form-main">
      {% csrf_token %}
      {% form_non_field_errors form %}
      <fieldset class="form-section">
        <legend>Machine Information</legend>
        <div class="form-field">
          {{ form.model.label_tag }}
          {{ form.model }}
          {% if form.model.help_text %}<small class="help-text">{{ form.model.help_text }}</small>{% endif %}
          {% field_errors form.model %}
        </div>
        <div class="form-field hidden" id="field-model-name">
          {{ form.model_name.label_tag }}
          {{ form.model_name }}
          {% if form.model_name.help_text %}<small class="help-text">{{ form.model_name.help_text }}</small>{% endif %}
          {% field_errors form.model_name %}
        </div>
        <div class="form-field hidden" id="field-manufacturer">
          {{ form.manufacturer.label_tag }}
          {{ form.manufacturer }}
          {% if form.manufacturer.help_text %}<small class="help-text">{{ form.manufacturer.help_text }}</small>{% endif %}
          {% field_errors form.manufacturer %}
        </div>
        <div class="form-field hidden" id="field-year">
          {{ form.year.label_tag }}
          {{ form.year }}
          {% if form.year.help_text %}<small class="help-text">{{ form.year.help_text }}</small>{% endif %}
          {% field_errors form.year %}
        </div>
        <div class="form-field hidden" id="field-name-override">
          {{ form.name_override.label_tag }}
          {{ form.name_override }}
          {% if form.name_override.help_text %}<small class="help-text">{{ form.name_override.help_text }}</small>{% endif %}
          {% field_errors form.name_override %}
        </div>
      </fieldset>
      <div class="form-actions">
        <a href="{% url 'maintainer-machine-list' %}" class="btn btn--secondary">
          <i class="fa-solid fa-circle-xmark meta"></i>
          Cancel
        </a>
        <button type="submit" class="btn btn--log">
          <i class="fa-solid fa-plus meta"></i>
          Create Machine
        </button>
      </div>
    </form>
  </div>
{% endblock %}
{% block extra_scripts %}
  <script>
    (function() {
      const modelSelect = document.getElementById('{{ form.model.id_for_label }}');
      const modelNameField = document.getElementById('field-model-name');
      const manufacturerField = document.getElementById('field-manufacturer');
      const yearField = document.getElementById('field-year');
      const nameOverrideField = document.getElementById('field-name-override');

      function updateFieldVisibility() {
        const isCreatingNewModel = !modelSelect.value;

        // Show/hide fields based on whether creating new model or selecting existing
        if (isCreatingNewModel) {
          // Show new model fields
          modelNameField.classList.remove('hidden');
          manufacturerField.classList.remove('hidden');
          yearField.classList.remove('hidden');
          // Hide name override
          nameOverrideField.classList.add('hidden');
        } else {
          // Hide new model fields
          modelNameField.classList.add('hidden');
          manufacturerField.classList.add('hidden');
          yearField.classList.add('hidden');
          // Show name override
          nameOverrideField.classList.remove('hidden');
        }
      }

      // Initialize on page load
      updateFieldVisibility();

      // Update when selection changes
      modelSelect.addEventListener('change', updateFieldVisibility);
    })();
  </script>
{% endblock %}
