{% extends "base.html" %}
{% load static %}
{% block title %}Machines · {{ block.super }}{% endblock %}
{% block content %}
  <h2>Machines</h2>
  <div class="list-header">
    <div class="list-header__left">
      <div class="form-field">
        <input type="search"
               id="machine-search"
               placeholder="Search..."
               class="search-input">
      </div>
    </div>
    <div class="list-header__right">
      <a href="{% url 'machine-quick-create' %}" class="btn btn-primary">+ New Machine</a>
    </div>
  </div>
  {% if machines %}
    <ul class="flip-card-list" id="machine-list">
      {% for machine in machines %}
        <li class="js-clickable-card"
            data-url="{% url 'maintainer-machine-detail' machine.slug %}"
            data-search-text="{{ machine.display_name }} {{ machine.model.year }} {{ machine.model.manufacturer }} {{ machine.get_operational_status_display }}{% if machine.location %} {{ machine.location.name }}{% endif %}"
            tabindex="0"
            role="button"
            aria-label="View {{ machine.display_name }}">
          <article class="flip-card flip-card--clickable">
            <div class="flip-card__top">
              <div class="flip-card__top-left">
                <span class="flip-card__title">
                  {{ machine.display_name }}
                  <span class="text-muted">・{{ machine.model.year }} {{ machine.model.manufacturer }}</span>
                </span>
              </div>
              <div class="flip-card__top-right">
                <span class="badge badge-status badge-{{ machine.operational_status }}">
                  {{ machine.get_operational_status_display }}
                </span>
              </div>
            </div>
            <div class="flip-card__main">
              <!-- Main content intentionally empty to keep meta in top/bottom rows -->
            </div>
            {% with loc=machine.location %}
              {% if machine.latest_open_report or loc and loc.slug != "floor" %}
                <div class="flip-card__bottom">
                  <div class="flip-card__bottom-left">
                    {% if machine.latest_open_report %}
                      <span class="flip-card__summary">
                        <span aria-hidden="true">❗</span><strong>Problem report:</strong> {{ machine.latest_open_report.0.description }}
                      </span>
                    {% endif %}
                  </div>
                  <div class="flip-card__bottom-right text-muted">
                    {% if loc and loc.slug != "floor" %}Location: {{ loc.name }}{% endif %}
                  </div>
                </div>
              {% endif %}
            {% endwith %}
          </article>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No machines yet.</p>
  {% endif %}
{% endblock %}
{% block extra_scripts %}
  <script src="{% static 'core/machine_filter.js' %}" defer></script>
{% endblock %}
