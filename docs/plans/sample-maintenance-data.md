# Sample Maintenance Data Plan

## Purpose
- Layer narrative-rich sample maintenance activity on top of the legacy imports so stakeholders can immediately see how tasks and log entries work without hand-entering data.
- Keep the dataset deterministic so it can be blown away and recreated whenever `python manage.py import_legacy_data [--clear]` is run.
- Showcase both visitor-submitted problem reports and maintainer-created tasks spanning 2024 → early 2025 → present day.

## Current Import Flow (for context)
1. `import_legacy_maintainers` loads users/Maintainer records from `docs/legacy_data/Maintainers.csv`.
2. `create_default_machines` creates the `MachineModel` + `MachineInstance` inventory with operational status/location metadata.
3. `import_legacy_maintenance_records` hydrates the historical tasks/logs from CSV (problem reports + standalone log entries).
4. **Gap:** No command currently fabricates richer on-going maintenance stories; we will insert a new command after step 3.

## Requirements Recap
- ≥5 tasks per machine, with ≥10 tasks for Ballyhoo.
- Mix of `Task.type == 'problem_report'` and `'task'`.
- Mix of open/closed statuses after the command runs.
- Every task gets ≥5 `LogEntry` records with varied actions:
  - plain notes (no status change)
  - `set_status` close
  - reopen
  - `set_machine_status` transitions (`good`, `fixing`, `broken`) where it makes sense.
- Log-entry timestamps must ascend within each task and never exceed the parent task’s closing time.
- Timeline should tell a coherent story for each machine, with believable faults for that era (PM, EM, solid-state, modern).
- Conversations should feel like 2–3 consistent maintainers shepherding a task to completion, not random assignments.
- Historical data should occupy 2024 + Q1 2025, then roll forward to ~present (use `timezone.now()` snapshots for “current” entries but never future dates).
- Leave **The Incredible Hulk** untouched so stakeholders can see what a machine with only legacy data (or none) looks like; every other machine should receive the sample overlays below.

## New Command: `create_sample_maintenance_data`
- Location: `the_flip/tickets/management/commands/create_sample_maintenance_data.py`.
- Called automatically by `import_legacy_data` after `import_legacy_maintenance_records` so it layers on top of CSV data.
- Options:
  - `--clear`: delete only the tasks/log-entries previously generated by this command before recreating them. Implementation detail below.
- No dry-run mode; rely on disposable local databases if you need to inspect output before keeping it.
- Idempotency strategy:
  - Introduce a `SAMPLE_BATCH_CODE = "sample-maintenance-2025"` constant.
  - Tag generated records using existing fields only:
    - Set `Task.reported_by_contact = "sample-data::<batch>"`.
    - Prefix sample `LogEntry.text` with `[Sample 2025]` so we can quickly search/clear them without schema changes.
  - `--clear` deletes any tasks whose `reported_by_contact` matches the batch value and cascades the log entries.
- Dependencies enforced at runtime:
  - Abort with helpful error if any maintainer usernames from `docs/legacy_data/Maintainers.csv` are missing, since scenarios will rotate through that full roster.
  - Abort if machines haven’t been created.

## Scenario Authoring Strategy
- Author a Python data structure (list/dict) describing a *scenario bundle* per machine:
  ```python
  SCENARIOS = {
      "Ballyhoo": {
          "base_date": datetime(2024, 1, 10, tzinfo=TZ),
          "maintainers": ["William", "Elijah"],
          "tasks": [
              {
                  "type": "problem_report",
                  "problem_type": Task.PROBLEM_STUCK_BALL,
                  "reported_by": {"name": "Visitor on Free Play Night", "contact": "freeplay@guest.com"},
                  "summary": "Ball hangs at the left scoring hole after payout.",
                  "story": [
                      {"delta_days": 0, "action": "note", "text": "William confirmed binding in chute.", "maintainers": ["William"]},
                      {"delta_days": 1, "action": "machine_status", "machine_status": "fixing", "text": "Pulled to workshop to polish guides.", "maintainers": ["William"]},
                      {"delta_days": 2, "action": "note", "text": "Elijah fabricated brass shim.", "maintainers": ["Elijah"]},
                      {"delta_days": 3, "action": "close", "text": "Chute smoothed, plays clean.", "maintainers": ["William","Elijah"]},
                      {"delta_days": 45, "action": "reopen", "text": "Issue resurfaced after humid day.", "maintainers": ["William"]},
                  ],
              },
              ...
          ],
      },
  }
  ```
- The command loops through each scenario, creates the task at `base_date + first_delta`, then walks the `story` list, calling helper methods:
  - `add_note` for `"note"`.
  - `set_status(Task.STATUS_CLOSED, …)` for `"close"`.
  - `set_status(Task.STATUS_OPEN, …)` for `"reopen"`.
  - `set_machine_status(...)` for `"machine_status"` actions (auto flips task status as needed).
- Each story step also bumps timestamps by `delta_days` + optional `delta_hours` to keep ordering natural.

## Machine Coverage Plan
| Machine | Era | Tasks Planned | Themes |
| --- | --- | --- | --- |
| Ballyhoo | PM | 10 | Bagatelle nails mushrooming, payout slides, ball lifter wear, spring tension, cabinet leveling. |
| Carom | Early EM | 5 | Totalizer window fog, payout relay misfires, payout cup jams. |
| Trade Winds | EM wartime conversion | 5 | Steppers gummed up, flasher sockets corroded, conversion wiring, warped playfield. |
| Baseball (Chicago Coin) | EM | 5 | Pitch motor slipping, flippers retrofitted, backbox lighting, coin door switch. |
| Derby Day | EM | 5 | Horse race unit timing, score motor noise, tilt bob sensitivity. |
| Roto Pool | EM | 5 | Rotating turret alignment, bumper scoring wires. |
| Teacher's Pet | EM | 5 | Bonus ladder miscounts, drop target reset bank. |
| Hokus Pokus | EM | 5 | Spinner relays, add-a-ball count, chimes mute. |
| Star Trip | SS | 5 | MPU battery corrosion, lamp matrix, saucer kickout power. |
| Star Trek (Bally) | SS | 5 | Sound board caps, drop target memory, cabinet wiring harness. |
| The Incredible Hulk | SS | 0 (leave blank) | No sample data; this machine demonstrates the empty-state experience. |
| Gorgar | SS | 5 | Magnet issues, speech sync, playfield swap prep. |
| Blackout | SS | 5 | Lamp strobing, speech board, power supply rebuild. |
| Hyperball | Hybrid | 5 | Ball cannon jams, fan noise, opto sensors. |
| Eight Ball Deluxe LE | SS | 5 | Inline drops, saucer kickout, feature lamps. |
| The Getaway: High Speed II | DMD | 5 | Supercharger speed, opto trough, diverter. |
| The Addams Family | DMD | 5 | Thing hand alignment, bookcase, power driver board. |
| Godzilla (Premium) | Modern | 5 | Insider Connected wifi, building mech, magna grab fine-tuning. |

Total tasks: 10 (Ballyhoo) + 17 machines × 5 + 0 (Hulk) = 95 tasks ≥ requirement, with Hulk intentionally excluded from sample creation.

## Narrative + Status Pattern per Task
- Ensure each task’s story escalates logically:
  1. **Initial intake** (problem report or maintainer TODO).
  2. **Diagnosis note** (no status change).
  3. **Machine pulled / marked fixing** (`set_machine_status('fixing')`).
  4. **Work-in-progress** (notes referencing parts, waiting on order).
  5. **Resolution** (`set_machine_status('good')` OR `set_status('closed')`).
  6. Optional **regression**: reopen after weeks, add more notes, re-close.
- Vary which steps perform the mandatory “≥5 log entries” requirement by adding periodic check-ins (e.g., “Ken resent coils order ETA Monday”).
- Spread timestamps:
  - Early history (Jan–Aug 2024) for long-ago closed tasks.
  - Shoulder season (Sep 2024–Feb 2025) for in-progress/regression stories.
  - Spring 2025 for fresh issues, leaving some open tasks dated within the last two weeks.

## Maintainer Assignment Rules
- Define persona pools:
- Era-focused pairings for realism (rotate within these pools as stories demand):
  - **Pre-war / purely mechanical (Ballyhoo):** William, Elijah, Sam plus lighter-touch helpers (Eddie, Luis) for waxing/cleanup.
  - **Early & mid EM (Carom → Hokus Pokus):** William, Elijah, Ken, Sam with cleaning assists from Jerry, Kyle, John.
  - **Early solid-state (Star Trip → Blackout):** Alex, Ben, Chris, Brian for boards; David or Ken when cabinet/mech work overlaps; add Josh/Justin for shop tasks.
  - **Hybrid/experimental (Hyperball):** Chris + Ben for electronics, Alex for diagnostics, Ethan/Eddie for mechanical cleaning.
  - **Early DMD (Eight Ball Deluxe LE → The Addams Family):** Alex, Ben, Chris, David; sprinkle in James/Jeff for cosmetic fixes.
  - **Modern Stern (Godzilla):** David, Brian primary; Ken or Alex for mechanical tweaks; Eddie/Luis for playfield cleaning.
- Rotate through the entire roster found in `Maintainers.csv`, mixing in lighter-duty crew (e.g., Eddie, Ethan, Luis, etc.) for cleaning, polishing, and inspection notes even if they rarely appear elsewhere.
- Each task should still feel like a focused conversation among 2–3 maintainers, but different tasks for a single machine can highlight different subsets of the roster over time.
- Public-submitted problem reports (e.g., weekend guests) get `reported_by_name` + `reported_by_contact`; maintainer-created tasks use `reported_by_user`.

## Data Quality Enhancements
- When a task shifts machine status to `fixing` or `broken`, simultaneously set `Task.status` to open (provided by helper).
- After a closing entry, leave at least one future log entry for the same task on a different day to simulate follow-up QA.
- Ensure machine-level `operational_status` matches the latest entry created by this command unless a legacy record already set something more recent; if conflict, append an extra log entry referencing legacy state to reconcile.
- Add occasional cross-task references in log text (“See Ballyhoo task ‘Payout scoop polish’ for similar fix”) for realism.

## Integration + Validation Steps
1. Implement `create_sample_maintenance_data` command per design.
2. Update `import_legacy_data.py` to append `('create_sample_maintenance_data', 'Creating sample maintenance data', True)` after the legacy maintenance import.
3. Document the new command in `README.md` (sample data section) once code exists.
4. Manual validation:
   - Run `python manage.py import_legacy_data --clear`.
   - Spot-check Ballyhoo detail page: expect 10 tasks, mix of statuses, each with ≥5 log entries.
   - Run `python manage.py shell` script to assert counts: tasks ≥ 95, log entries ≥ 475 from the sample batch, zero future timestamps.

## Open Questions / Decisions
_(None at this time — requirements above incorporate the latest guidance. Ready to implement once approved.)_
